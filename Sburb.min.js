"undefined"==typeof Iuppiter&&(Iuppiter={version:"$Revision: 3026 $".substring(11).replace(" $","")}),Iuppiter.toByteArray=function(t){var e,i,s=[];for(e=0;e<t.length;e++)i=t.charCodeAt(e),i<=127?s.push(i):i<=2047?(s.push(i>>6|192),s.push(63&i|128)):i<=65535?(s.push(i>>12|224),s.push(i>>6&63|128),s.push(63&i|128)):(s.push(i>>18|240),s.push(i>>12&63|128),s.push(i>>6&63|128),s.push(63&i|128));return s},Iuppiter.Base64={CA:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",CAS:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",IA:new Array(256),IAS:new Array(256),init:function(){var t;for(t=0;t<256;t++)Iuppiter.Base64.IA[t]=-1,Iuppiter.Base64.IAS[t]=-1;for(t=0,iS=Iuppiter.Base64.CA.length;t<iS;t++)Iuppiter.Base64.IA[Iuppiter.Base64.CA.charCodeAt(t)]=t,Iuppiter.Base64.IAS[Iuppiter.Base64.CAS.charCodeAt(t)]=t;Iuppiter.Base64.IA["="]=Iuppiter.Base64.IAS["="]=0},encode:function(t,e){var i,s,n,a,o,r,h,l,u,c;for(i=e?Iuppiter.Base64.CAS:Iuppiter.Base64.CA,n=t.constructor==Array?t:Iuppiter.toByteArray(t),a=n.length,o=a/3*3,r=(a-1)/3+1<<2,s=new Array(r),h=0,l=0;h<o;)c=(255&n[h++])<<16|(255&n[h++])<<8|255&n[h++],s[l++]=i.charAt(c>>18&63),s[l++]=i.charAt(c>>12&63),s[l++]=i.charAt(c>>6&63),s[l++]=i.charAt(63&c);return u=a-o,u>0&&(c=(255&n[o])<<10|(2==u?(255&n[a-1])<<2:0),s[r-4]=i.charAt(c>>12),s[r-3]=i.charAt(c>>6&63),s[r-2]=2==u?i.charAt(63&c):"=",s[r-1]="="),s.join("")},decode:function(t,e){var i,s,n,a,o,r,h,l,u,c,d,f,p,g,m,y;for(i=e?Iuppiter.Base64.IAS:Iuppiter.Base64.IA,t.constructor==Array?(n=t,o=!0):(n=Iuppiter.toByteArray(t),o=!1),a=n.length,r=0,h=a-1;r<h&&i[n[r]]<0;)r++;for(;h>0&&i[n[h]]<0;)h--;for(l="="==n[h]?"="==n[h-1]?2:1:0,u=h-r+1,c=a>76?("\r"==n[76]?u/78:0)<<1:0,d=(6*(u-c)>>3)-l,s=new Array(d),f=0,p=0,eLen=d/3*3;f<eLen;)g=i[n[r++]]<<18|i[n[r++]]<<12|i[n[r++]]<<6|i[n[r++]],s[f++]=g>>16&255,s[f++]=g>>8&255,s[f++]=255&g,c>0&&19==++p&&(r+=2,p=0);if(f<d){for(g=0,m=0;r<=h-l;m++)g|=i[n[r++]]<<18-6*m;for(y=16;f<d;y-=8)s[f++]=g>>y&255}if(o)return s;for(g=0;g<s.length;g++)s[g]=String.fromCharCode(s[g]);return s.join("")}},Iuppiter.Base64.init(),function(){NBBY=8,MATCH_BITS=6,MATCH_MIN=3,MATCH_MAX=(1<<MATCH_BITS)+(MATCH_MIN-1),OFFSET_MASK=(1<<16-MATCH_BITS)-1,LEMPEL_SIZE=256,Iuppiter.compress=function(t){var e,i,s,n,a,o,r,h,l,u=[],c=0,d=0,f=1<<NBBY-1,p=new Array(LEMPEL_SIZE);for(h=0;h<LEMPEL_SIZE;h++)p[h]=3435973836;for(t.constructor==Array?(e=t,l=!0):(e=Iuppiter.toByteArray(t),l=!1),i=e.length;c<i;){if((f<<=1)==1<<NBBY){if(d>=i-1-2*NBBY){for(a=i,c=0,d=0;a;a--)u[d++]=e[c++];return u}f=1,n=d,u[d++]=0}if(c>i-MATCH_MAX)u[d++]=e[c++];else if(r=(e[c]+13^e[c+1]-13^e[c+2])&LEMPEL_SIZE-1,o=c-p[r]&OFFSET_MASK,p[r]=c,s=c-o,s>=0&&s!=c&&e[c]==e[s]&&e[c+1]==e[s+1]&&e[c+2]==e[s+2]){for(u[n]|=f,a=MATCH_MIN;a<MATCH_MAX&&e[c+a]==e[s+a];a++);u[d++]=a-MATCH_MIN<<NBBY-MATCH_BITS|o>>NBBY,u[d++]=o,c+=a}else u[d++]=e[c++]}return u},Iuppiter.decompress=function(t,e){var i,s,n,a,o,r,h,l,u,c=[],d=0,f=0,p=1<<NBBY-1;for(t.constructor==Array?(i=t,l=!0):(i=Iuppiter.toByteArray(t),l=!1),l="undefined"!=typeof e&&e,s=i.length,u=function(){if(l)return c;for(h=0;h<f;h++)c[h]=String.fromCharCode(c[h]);return c.join("")};d<s;)if((p<<=1)==1<<NBBY&&(p=1,a=i[d++]),a&p){if(o=(i[d]>>NBBY-MATCH_BITS)+MATCH_MIN,r=(i[d]<<NBBY|i[d+1])&OFFSET_MASK,d+=2,!((n=f-r)>=0))return u();for(;--o>=0;)c[f++]=c[n++]}else c[f++]=i[d++];return u()}}(),window.Modernizr=function(t,e,i){function s(t){v.cssText=t}function n(t,e){return typeof t===e}function a(t,e){return!!~(""+t).indexOf(e)}function o(t,e){for(var s in t){var n=t[s];if(!a(n,"-")&&v[n]!==i)return"pfx"!=e||n}return!1}function r(t,e,s){for(var a in t){var o=e[t[a]];if(o!==i)return s===!1?t[a]:n(o,"function")?o.bind(s||e):o}return!1}function h(t,e,i){var s=t.charAt(0).toUpperCase()+t.slice(1),a=(t+" "+x.join(s+" ")+s).split(" ");return n(e,"string")||n(e,"undefined")?o(a,e):(a=(t+" "+b.concat(x).join(s+" ")+s).split(" "),r(a,e,i))}function l(t,e,i){return e?h(t,e,i):h(t,"pfx")}var u,c,d,f="2.6.2",p={},g=e.documentElement,m="modernizr",y=e.createElement(m),v=y.style,w=({}.toString,"Webkit Moz O ms MS"),x=w.split(" "),b=w.toLowerCase().split(" "),S={},A=[],I=A.slice,M=function(t,i,s,n){var a,o,r,h,l=e.createElement("div"),u=e.body,c=u||e.createElement("body");if(parseInt(s,10))for(;s--;)r=e.createElement("div"),r.id=n?n[s]:m+(s+1),l.appendChild(r);return a=["&#173;",'<style id="s',m,'">',t,"</style>"].join(""),l.id=m,(u?l:c).innerHTML+=a,c.appendChild(l),u||(c.style.background="",c.style.overflow="hidden",h=g.style.overflow,g.style.overflow="hidden",g.appendChild(c)),o=i(l,t),u?l.parentNode.removeChild(l):(c.parentNode.removeChild(c),g.style.overflow=h),!!o},N={}.hasOwnProperty;d=n(N,"undefined")||n(N.call,"undefined")?function(t,e){return e in t&&n(t.constructor.prototype[e],"undefined")}:function(t,e){return N.call(t,e)},Function.prototype.bind||(Function.prototype.bind=function(t){var e=this;if("function"!=typeof e)throw new TypeError;var i=I.call(arguments,1),s=function(){if(this instanceof s){var n=function(){};n.prototype=e.prototype;var a=new n,o=e.apply(a,i.concat(I.call(arguments)));return Object(o)===o?o:a}return e.apply(t,i.concat(I.call(arguments)))};return s}),S.canvas=function(){var t=e.createElement("canvas");return!(!t.getContext||!t.getContext("2d"))},S.canvastext=function(){return!(!p.canvas||!n(e.createElement("canvas").getContext("2d").fillText,"function"))},S.fontface=function(){var t;return M('@font-face {font-family:"font";src:url("https://")}',function(i,s){var n=e.getElementById("smodernizr"),a=n.sheet||n.styleSheet,o=a?a.cssRules&&a.cssRules[0]?a.cssRules[0].cssText:a.cssText||"":"";t=/src/i.test(o)&&0===o.indexOf(s.split(" ")[0])}),t},S.audio=function(){var t=e.createElement("audio"),i=!1;try{(i=!!t.canPlayType)&&(i=new Boolean(i),i.ogg=t.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,""),i.mp3=t.canPlayType("audio/mpeg;").replace(/^no$/,""),i.wav=t.canPlayType('audio/wav; codecs="1"').replace(/^no$/,""),i.m4a=(t.canPlayType("audio/x-m4a;")||t.canPlayType("audio/aac;")).replace(/^no$/,""))}catch(t){}return i},S.localstorage=function(){try{return localStorage.setItem(m,m),localStorage.removeItem(m),!0}catch(t){return!1}},S.sessionstorage=function(){try{return sessionStorage.setItem(m,m),sessionStorage.removeItem(m),!0}catch(t){return!1}},S.xhr2=function(){return"FormData"in t},S.json=function(){return!!t.JSON&&!!JSON.parse},S.filereader=function(){return!!(t.File&&t.FileList&&t.FileReader)},S.xmlserializer=function(){return"XMLSerializer"in t},S.overridemimetype=function(){return!!(new XMLHttpRequest).overrideMimeType},S.vbarray=function(){return"VBArray"in t},S.blob=function(){var e=!1;try{if(e="Blob"in t){e=new Boolean(e),e.slice=!!l("slice",Blob.prototype,!1),e.builder=!!l("BlobBuilder",t,!1),e.url=!!l("URL",t,!1);try{var i=t[l("URL",t,!1)],s=i.createObjectURL(new Blob([0,0]),{autoRevoke:!1});e.revoke=!0,i.revokeObjectURL(s)}catch(t){e.revoke=!1}try{e.creator=!!new Blob}catch(t){e.creator=!1}}}catch(t){}return e},S.arraybuffer=function(){var e=!1;try{(e="ArrayBuffer"in t)&&(e=new Boolean(e),e.dataview=!!l("Uint8Array",t,!1))}catch(t){}return e};for(var T in S)d(S,T)&&(c=T.toLowerCase(),p[c]=S[T](),A.push((p[c]?"":"no-")+c));return p.addTest=function(t,e){if("object"==typeof t)for(var s in t)d(t,s)&&p.addTest(s,t[s]);else{if(t=t.toLowerCase(),p[t]!==i)return p;e="function"==typeof e?e():e,"undefined"!=typeof enableClasses&&enableClasses&&(g.className+=" "+(e?"":"no-")+t),p[t]=e}return p},s(""),y=u=null,p._version=f,p.testStyles=M,p._domPrefixes=b,p._cssomPrefixes=x,p.testProp=function(t){return o([t])},p.testAllProps=h,p.prefixed=l,p}(this,this.document),function(){var t=new Image;t.onerror=function(){Modernizr.addTest("datauri",function(){return!1})},t.onload=function(){Modernizr.addTest("datauri",function(){return 1==t.width&&1==t.height})},t.src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw=="}(),"function"!=typeof String.prototype.trim&&(String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")}),"function"!=typeof Array.prototype.remove&&(Array.prototype.remove=function(t,e){var i=this.slice((e||t)+1||this.length);return this.length=t<0?this.length+t:t,this.push.apply(this,i)}),"function"!=typeof Array.prototype.contains&&(Array.prototype.contains=function(t){return this.indexOf(t)>-1}),Array.prototype.destroy=function(t){var e=this.indexOf(t);e>=0&&this.remove(e)},function(){var t="undefined"!=typeof window?window:exports,e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",i=function(){try{document.createElement("$")}catch(t){return t}}();t.btoa||(t.btoa=function(t){for(var s,n,a=0,o=e,r="";t.charAt(0|a)||(o="=",a%1);r+=o.charAt(63&s>>8-a%1*8)){if(n=t.charCodeAt(a+=.75),n>255)throw i;s=s<<8|n}return r}),t.atob||(t.atob=function(t){if(t=t.replace(/=+$/,""),t.length%4==1)throw i;for(var s,n,a=0,o=0,r="";n=t.charAt(o++);~n&&(s=a%4?64*s+n:n,a++%4)?r+=String.fromCharCode(255&s>>(-2*a&6)):0)n=e.indexOf(n);return r})}();var Sburb=function(t){function e(){i(),t.assetManager.stop(),t.updateLoop=setInterval(s,1e3/t.Stage.fps),t.drawLoop=setInterval(n,1e3/t.Stage.fps)}function i(){t.updateLoop&&(clearInterval(t.updateLoop),clearInterval(t.drawLoop),t.updateLoop=t.drawLoop=null),t.assetManager.start()}function s(){r(),h(),l(),t.loadingRoom||t.curRoom.update(),d(),f(),t.chooser.update(),t.dialoger.update(),g(),y()}function n(){t.playingMovie||(t.stage.save(),t.Stage.offset=!0,t.stage.translate(-t.Stage.x,-t.Stage.y),t.curRoom.draw(),t.stage.restore(),t.Stage.offset=!1,t.Stage.fade>.1&&(t.stage.fillStyle="rgba(0,0,0,"+t.Stage.fade+")",t.stage.fillRect(0,0,t.Stage.width,t.Stage.height)),t.dialoger.draw(),u(),t.stage.save(),t.Stage.offset=!0,t.stage.translate(-t.Stage.x,-t.Stage.y),t.chooser.draw(),t.stage.restore(),t.Stage.offset=!1,t.debugger.draw())}function a(){t.pressed={},t.pressedOrder=[]}function o(t,e){var i=0,s=0,n=0,a=0,o=e;do i+=o.offsetLeft,s+=o.offsetTop;while(o=o.offsetParent);return n=t.pageX-i,a=t.pageY-s,{x:n,y:a}}function r(){t.bgm&&t.bgm.asset&&((t.bgm.asset.ended||t.bgm.asset.currentTime>=t.bgm.asset.duration)&&t.bgm.loop(),t.lastMusicTime==t.bgm.asset.currentTime?(t.musicStoppedFor++,t.musicStoppedFor>4&&(t.bgm.asset.pause(),t.bgm.asset.play())):t.musicStoppedFor=0,t.bgm.asset.paused&&t.bgm.play(),t.lastMusicTime=t.bgm.asset.currentTime)}function h(){t.Stage&&(t.Stage.style.cursor="default"),c()&&!t.inputDisabled?t.char.handleInputs(t.pressed,t.pressedOrder):t.char.moveNone(),t.debugger.handleInputs(t.pressed)}function l(){for(var e in t.hud)if(t.hud.hasOwnProperty(e)){var i=t.hud[e];i.update()}}function u(){for(var e in t.hud)t.hud.hasOwnProperty(e)&&t.hud[e].draw()}function c(){return!(t.dialoger.talking||t.chooser.choosing||t.destRoom||t.fading||t.destFocus)}function d(){t.destFocus?Math.abs(t.destFocus.x-t.cam.x-t.Stage.width/2)>4||Math.abs(t.destFocus.y-t.cam.y-t.Stage.height/2)>4?(t.cam.x+=(t.destFocus.x-t.Stage.width/2-t.cam.x)/5,t.cam.y+=(t.destFocus.y-t.Stage.height/2-t.cam.y)/5):(t.focus=t.destFocus,t.destFocus=null):t.focus&&(t.cam.x=t.focus.x-t.Stage.width/2,t.cam.y=t.focus.y-t.Stage.height/2),t.Stage.x=Math.max(0,Math.min(Math.round(t.cam.x/t.Stage.scaleX)*t.Stage.scaleX,t.curRoom.width-t.Stage.width)),t.Stage.y=Math.max(0,Math.min(Math.round(t.cam.y/t.Stage.scaleX)*t.Stage.scaleX,t.curRoom.height-t.Stage.height))}function f(){if(t.destRoom||t.fading)if(t.Stage.fade<1.1)t.Stage.fade=Math.min(1.1,t.Stage.fade+t.Stage.fadeRate);else if(t.destRoom){for(var e=t.destX-t.char.x,i=t.destY-t.char.y,s=t.char;s;)s.x+=e,s.y+=i,s.followBuffer=[],s=s.follower;t.moveSprite(t.char,t.curRoom,t.destRoom),t.curRoom.exit(),t.curRoom=t.destRoom,t.curRoom.enter(),t.destRoom=null}else t.fading=!1;else c()&&t.Stage.fade>.01&&(t.Stage.fade=Math.max(.01,t.Stage.fade-t.Stage.fadeRate))}function p(){t.char.idle(),t.chooser.beginChoosing(t.char.x,t.char.y)}function g(){t.curAction&&m(t);for(var e=0;e<t.actionQueues.length;e++){var i=t.actionQueues[e];if(i.curAction){if(i.paused||i.waitFor){if(!(i.trigger&&i.trigger.checkCompletion()||i.waitFor))continue;i.paused=!1,i.trigger=null}m(i)}else t.actionQueues.remove(e),e--}}function m(e){e.curAction.times<=0?e.curAction.followUp?(c()||e.curAction.followUp.noWait||e.noWait)&&t.performAction(e.curAction.followUp,e):e.curAction=null:(c()||e.curAction.noWait||e.noWait)&&t.performAction(e.curAction,e)}function y(){t.waitFor&&t.waitFor.checkCompletion()&&(t.waitFor=null),t.inputDisabled&&t.inputDisabled.checkCompletion&&t.inputDisabled.checkCompletion()&&(t.inputDisabled=!1)}function v(e,i){var s=!1;i.curAction=e.clone();do{s&&(i.curAction=i.curAction.followUp.clone());var n=t.performActionSilent(i.curAction);w(i,n),s=!0}while(i.curAction&&i.curAction.times<=0&&i.curAction.followUp&&i.curAction.followUp.noDelay)}function w(t,e){e&&(t.hasOwnProperty("trigger")?(t.paused=!0,t.trigger=e):t.waitFor=e)}t.Keys={backspace:8,tab:9,enter:13,shift:16,ctrl:17,alt:18,escape:27,space:32,left:37,up:38,right:39,down:40,w:87,a:65,s:83,d:68,tilde:192},t.name="Jterniabound",t.version="1.0",t.Container=null,t.Game=null,t.Map=null,t.Stage=null,t.Bins={},t.cam={x:0,y:0},t.crashed=!1,t.stage=null,t.gameState={},t.pressed=null,t.pressedOrder=null,t.debugger=null,t.assetManager=null,t.assets=null,t.sprites=null,t.effects=null,t.buttons=null,t.rooms=null,t.char=null,t.curRoom=null,t.destRoom=null,t.destX=null,t.destY=null,t.focus=null,t.destFocus=null,t.chooser=null,t.inputDisabled=!1,t.curAction=null,t.actionQueues=[],t.nextQueueId=0,t.bgm=null,t.hud=null,t.Mouse={down:!1,x:0,y:0},t.waitFor=null,t.engineMode="wander",t.fading=!1,t.lastMusicTime=-1,t.musicStoppedFor=0,t.loadingRoom=!1,t.tests=null,t.prefixed=null,t.firedAsync=!1,t.updateLoop=null,t.initFinished=null,t._hardcode_load=null,t._include_dev=!1;t.testCompatibility=function(e,i,s){if(Modernizr.xhr2&&!t.firedAsync){try{var n=new XMLHttpRequest;n.open("GET",i,!0),n.responseType="blob",n.onload=function(){200!=this.status&&0!=this.status||!this.response?Modernizr.addTest("xhrblob",function(){return!1}):Modernizr.addTest("xhrblob",function(){return!0})},n.onabort=function(){Modernizr.addTest("xhrblob",function(){return!1})},n.onerror=function(){Modernizr.addTest("xhrblob",function(){return!1})},n.send(),n=new XMLHttpRequest,n.open("GET",i,!0),n.responseType="arraybuffer",n.onload=function(){if(200!=this.status&&0!=this.status||!this.response)Modernizr.addTest("xhrarraybuffer",function(){return!1});else{this.response;Modernizr.addTest("xhrarraybuffer",function(){return!0})}},n.onabort=function(){Modernizr.addTest("xhrarraybuffer",function(){return!1})},n.onerror=function(){Modernizr.addTest("xhrarraybuffer",function(){return!1})},n.send()}catch(t){alert(t.message+"\n\nIf you are running Google Chrome, you need to run it with the -allow-file-access-from-files switch to load this.")}t.firedAsync=!0}else Modernizr.addTest("xhrblob",function(){return!1}),Modernizr.addTest("xhrarraybuffer",function(){return!1});if(!("xhrblob"in Modernizr&&"xhrarraybuffer"in Modernizr&&"datauri"in Modernizr))return setTimeout(function(){t.initialize(e,i,s)},200),void(t.crashed=!0);var a=[];if(Modernizr.fontface||a.push("- Lack of CSS @font-face support."),Modernizr.canvas||a.push("- Lack of canvas support."),Modernizr.canvastext||a.push("- Lack of canvas text support."),Modernizr.json||a.push("- Lack of JSON support."),Modernizr.xmlserializer||a.push("- Lack of XMLSerializer support."),a.length){var o='<div style="padding-left: 0; padding-right: 0; margin-left: auto; margin-right: auto; display: block; width:650px; height:450px; overflow: auto;">';o+='<p style="font-weight: bold;">Your browser is too old. Here are the problems we found:</p>';for(var r=0;r<a.length;r++)o+="<p>"+a[r]+"</p>";o+="<p>Maybe try Chrome instead?</p>",o+="</div>",document.getElementById(e).innerHTML=o,t.crashed=!0}else t.prefixed=Modernizr.prefixed,t.tests={},t.tests.blobrevoke=Modernizr.blob&&Modernizr.blob.revoke,Modernizr.audio&&(Modernizr.audio.mp3||Modernizr.audio.ogg)?(t.tests.audio=new Boolean(!0),t.tests.audio.mp3=Modernizr.audio.mp3,t.tests.audio.ogg=Modernizr.audio.ogg):t.tests.audio=!1,Modernizr.localstorage||Modernizr.sessionstorage?(t.tests.storage=new Boolean(!0),t.tests.storage.local=Modernizr.localstorage,t.tests.storage.session=Modernizr.sessionstorage):t.tests.storage=!1,t.tests.loading=0,Modernizr.xhrblob&&Modernizr.blob&&Modernizr.blob.url&&Modernizr.blob.creator?t.tests.loading=11:Modernizr.xhrblob&&Modernizr.blob&&Modernizr.blob.url&&Modernizr.blob.builder?t.tests.loading=10:Modernizr.xhrblob&&Modernizr.blob&&Modernizr.blob.url&&Modernizr.blob.slice?t.tests.loading=9:Modernizr.xhrblob&&Modernizr.datauri&&Modernizr.filereader?t.tests.loading=8:Modernizr.xhrarraybuffer&&Modernizr.arraybuffer&&Modernizr.arraybuffer.dataview&&Modernizr.blob&&Modernizr.blob.url&&Modernizr.blob.creator?t.tests.loading=7:Modernizr.xhrarraybuffer&&Modernizr.arraybuffer&&Modernizr.blob&&Modernizr.blob.url&&Modernizr.blob.creator?t.tests.loading=6:Modernizr.xhrarraybuffer&&Modernizr.arraybuffer&&Modernizr.blob&&Modernizr.blob.url&&Modernizr.blob.builder?t.tests.loading=5:Modernizr.xhrarraybuffer&&Modernizr.arraybuffer&&Modernizr.arraybuffer.dataview&&Modernizr.datauri?t.tests.loading=4:Modernizr.overridemimetype&&Modernizr.blob&&Modernizr.blob.url&&Modernizr.blob.creator&&Modernizr.arraybuffer&&Modernizr.arraybuffer.dataview?t.tests.loading=3:Modernizr.overridemimetype&&Modernizr.blob&&Modernizr.blob.url&&Modernizr.blob.builder&&Modernizr.arraybuffer&&Modernizr.arraybuffer.dataview?t.tests.loading=2:Modernizr.overridemimetype&&Modernizr.datauri?t.tests.loading=1:Modernizr.vbarray&&Modernizr.datauri&&(t.tests.loading=12)},t.initialize=function(e,i,s){if(t.crashed=!1,t.testCompatibility(e,i,s),!t.crashed){t.debugger=new t.Debugger;var n=document.createElement("div");n.style.position="relative",n.style.padding="0",n.style.margin="auto";var a=document.createElement("div");a.id="SBURBgameDiv",a.onkeydown=x,a.onkeyup=b,a.style.position="absolute",a.style.zIndex="100",n.appendChild(a);var o=document.createElement("div");o.id="SBURBmovieBin",o.style.position="absolute",o.style.zIndex="200",n.appendChild(o);var r=document.createElement("div");r.id="SBURBfontBin",n.appendChild(r);var h=document.createElement("div");h.id="SBURBgifBin",h.style.width="0",h.style.height="0",h.style.overflow="hidden",n.appendChild(h);var l=document.createElement("canvas");l.id="SBURBStage",l.onmousedown=function(e){t.onMouseDown(e,this)},l.onmouseup=function(e){t.onMouseUp(e,this)},l.onmousemove=function(e){t.onMouseMove(e,this)},l.tabIndex=0,l.scaleX=l.scaleY=3,l.x=l.y=0,l.fps=30,l.fade=0,l.fadeRate=.1,l.innerText="ERROR: Your browser is too old to display this content!",a.appendChild(l);var u=document.createElement("canvas");u.id="SBURBMapCanvas",u.width=1,u.height=1,u.style.display="none",a.appendChild(u),document.getElementById(e).appendChild(n),t.Container=n,t.Game=a,t.Map=u,t.Stage=l,t.Bins.movie=o,t.Bins.font=r,t.Bins.gif=h,t.setDimensions(650,450),t.stage=t.Stage.getContext("2d"),t.Stage.onblur=S,t.chooser=new t.Chooser,t.dialoger=null,t.assetManager=new t.AssetManager,t.assets=t.assetManager.assets,t.rooms={},t.sprites={},t.effects={},t.buttons={},t.hud={},t.gameState={},t.pressed={},t.pressedOrder=[],t.loadSerialFromXML(i)}},t.setDimensions=function(e,i){e&&(t.Container.style.width=e+"px",t.Stage.width=e),i&&(t.Container.style.height=i+"px",t.Stage.height=i)};var x=function(e){if(t.updateLoop&&!t.inputDisabled)if(t.chooser.choosing)e.keyCode!=t.Keys.down&&e.keyCode!=t.Keys.s||t.chooser.nextChoice(),e.keyCode!=t.Keys.up&&e.keyCode!=t.Keys.w||t.chooser.prevChoice(),e.keyCode!=t.Keys.space||t.pressed[t.Keys.space]||(t.performAction(t.chooser.choices[t.chooser.choice]),t.chooser.choosing=!1);else if(t.dialoger.talking)e.keyCode!=t.Keys.space||t.pressed[t.Keys.space]||t.dialoger.nudge();else if(c()&&e.keyCode==t.Keys.space&&!t.pressed[t.Keys.space]&&"wander"==t.engineMode){t.chooser.choices=[];for(var i=t.char.getActionQueries(),s=0;s<i.length&&(t.chooser.choices=t.curRoom.queryActions(t.char,i[s].x,i[s].y),!(t.chooser.choices.length>0));s++);t.chooser.choices.length>0&&(t.chooser.choices.push(new t.Action("cancel","cancel","Cancel.")),p())}return t.pressed[e.keyCode]||t.pressedOrder.push(e.keyCode),t.pressed[e.keyCode]=!0,!!(e.altKey||e.ctrlKey||e.metaKey)},b=function(e){t.pressed[e.keyCode]&&t.pressedOrder.destroy(e.keyCode),t.pressed[e.keyCode]=!1},S=function(t){a()};return t.onMouseMove=function(e,i){var s=o(e,i);t.Mouse.x=s.x,t.Mouse.y=s.y},t.onMouseDown=function(e,i){t.updateLoop&&("strife"==t.engineMode&&c()&&(t.chooser.choices=t.curRoom.queryActionsVisual(t.char,t.Stage.x+t.Mouse.x,t.Stage.y+t.Mouse.y),t.chooser.choices.length>0&&(t.chooser.choices.push(new t.Action("cancel","cancel","cancel")),p())),t.Mouse.down=!0)},t.onMouseUp=function(e,i){t.Mouse.down=!1,t.updateLoop&&t.dialoger&&t.dialoger.box&&t.dialoger.box.isVisuallyUnder(t.Mouse.x,t.Mouse.y)&&t.dialoger.nudge()},t.performAction=function(e,i){if(e.silent){if(1==e.times&&!e.followUp)return t.performActionSilent(e),null;if(!i||i==t){if(e.silent===!0)i=new t.ActionQueue(e);else{var s=e.silent.split(":"),n="full"==s[0],a=null;n&&s.shift(),s.length>0&&(a=s.shift()),i=new t.ActionQueue(e,a,s,n)}t.actionQueues.push(i)}}return i&&i!=t?(v(e,i),i):(t.curAction&&t.curAction.followUp!=e&&t.curAction!=e||!c())&&e.soft?null:(v(e,t),null)},t.performActionSilent=function(e){e.times--;var i=e.info();return i&&(i=i.trim()),t.commands[e.command.trim()](i)},t.changeRoom=function(e,i,s){t.destRoom=e,t.destX=i,t.destY=s},t.moveSprite=function(t,e,i){for(var s=t;s;)e.removeSprite(s),i.addSprite(s),s=s.follower},t.setCurRoomOf=function(e){if(!t.curRoom.contains(e))for(var i in t.rooms)if(t.rooms.hasOwnProperty(i)&&t.rooms[i].contains(e))return void t.changeRoom(t.rooms[i],t.char.x,t.char.y)},t.changeBGM=function(e){if(e){if(t.bgm){if(t.bgm.asset==e.asset&&t.bgm.startLoop==e.startLoop)return;t.bgm.stop()}t.bgm=e,t.bgm.stop(),t.bgm.play()}},t.playEffect=function(e,i,s){t.curRoom.addEffect(e.clone(i,s))},t.playSound=function(t){t.stop(),t.play()},t.playMovie=function(e){var i=e.name;document.getElementById(i).style.display="block",t.waitFor=new t.Trigger("movie,"+i+",5"),t.playingMovie=!0},t.startUpdateProcess=e,t.haltUpdateProcess=i,t.draw=n,t}(Sburb||{}),Sburb=function(t){function e(t,e,i,s,n,a,o,r,h){this.x=e,this.y=i,this.dx="number"==typeof a?a:0,this.dy="number"==typeof o?o:0,this.width=s,this.height=n,this.depthing="number"==typeof r?r:this.BG_DEPTHING,this.collidable="boolean"==typeof h&&h,this.animations={},this.animation=null,this.state=null,this.lastTime=0,this.actions=[],this.name=t,this.queries=null}return e.prototype.BG_DEPTHING=0,e.prototype.MG_DEPTHING=1,e.prototype.FG_DEPTHING=2,e.prototype.addAnimation=function(t){this.animations[t.name]=t},e.prototype.startAnimation=function(t){this.state!=t&&this.animations[t]&&(this.animation=this.animations[t],this.animation.reset(),this.state=t)},e.prototype.update=function(t){this.animation&&(this.animation.hasPlayed()&&this.animation.followUp?this.startAnimation(this.animation.followUp):this.animation.update())},e.prototype.draw=function(){this.animation&&this.animation.draw(this.x,this.y)},e.prototype.isBehind=function(t){return this.depthing==t.depthing?this.y+this.dy<t.y+t.dy:this.depthing<t.depthing},e.prototype.collides=function(t,e,i){var s=this.x+(e?e:0),n=this.y+(i?i:0);return!!(t.collidable&&s-this.width/2<t.x+t.width/2&&s+this.width/2>t.x-t.width/2&&n-this.height/2<t.y+t.height/2&&n+this.height/2>t.y-t.height/2)},e.prototype.hitsPoint=function(t,e){return this.x-this.width/2<=t&&this.x+this.width/2>=t&&this.y-this.height/2<=e&&this.y+this.height/2>=e},e.prototype.isVisuallyUnder=function(t,e){return this.animation&&this.animation.isVisuallyUnder(t-this.x,e-this.y)},e.prototype.addAction=function(t){this.actions.push(t)},e.prototype.removeAction=function(t){for(var e=0;e<this.actions.length;e++)if(this.actions[e].name==t)return void this.actions.splice(e,1)},e.prototype.getActions=function(t){for(var e=[],i=0;i<this.actions.length;i++){var s=this.actions[i],n=s.sprite;(!n||n==t.name||"!"==n.charAt(0)&&n.substring(1)!=t.name)&&e.push(s)}return e},e.prototype.getBoundaryQueries=function(t,e){var i=this.x+(t?t:0),s=this.y+(e?e:0),n=this.width/2,a=this.height/2;return this.queries||(this.queries={upRight:{},upLeft:{},downLeft:{},downRight:{},downMid:{},upMid:{}}),this.queries.upRight.x=i+n,this.queries.upRight.y=s-a,this.queries.upLeft.x=i-n,this.queries.upLeft.y=s-a,this.queries.downLeft.x=i-n,this.queries.downLeft.y=s+a,this.queries.downRight.x=i+n,this.queries.downRight.y=s+a,this.queries.downMid.x=i,this.queries.downMid.y=s+a,this.queries.upMid.x=i,this.queries.upMid.y=s-a,this.queries},e.prototype.serialize=function(e){var i=0;for(var s in this.animations)this.animations.hasOwnProperty(s)&&i++;e=e.concat("\n<sprite "+t.serializeAttributes(this,"name","x","y","dx","dy","width","height","depthing","collidable")+(i>1?"state='"+this.state+"' ":"")+">");for(var s in this.animations)this.animations.hasOwnProperty(s)&&(e=this.animations[s].serialize(e));for(var n=0;n<this.actions.length;n++)e=this.actions[n].serialize(e);return e=e.concat("\n</sprite>")},e.prototype.clone=function(e){var i=new t.Sprite(e,this.x,this.y,this.width,this.height,this.dx,this.dy,this.depthing,this.collidable);for(var s in this.animations)this.animations.hasOwnProperty(s)&&i.addAnimation(this.animations[s].clone());for(var n in this.actions)this.actions.hasOwnProperty(n)&&i.addAction(this.actions[n].clone());return this.animation&&i.startAnimation(this.animation.name),t.sprites[e]=i,i},t.parseSprite=function(i,s){var n,a=i.attributes,o=null,r=0,h=0,l=0,u=0,c=0,d=0,f=0,p=!1,g=null;o=(n=a.getNamedItem("name"))?n.value:o,r=(n=a.getNamedItem("x"))?parseInt(n.value):r,h=(n=a.getNamedItem("y"))?parseInt(n.value):h,l=(n=a.getNamedItem("width"))?parseInt(n.value):l,u=(n=a.getNamedItem("height"))?parseInt(n.value):u,c=(n=a.getNamedItem("dx"))?parseInt(n.value):c,d=(n=a.getNamedItem("dy"))?parseInt(n.value):d,f=(n=a.getNamedItem("depthing"))?parseInt(n.value):f,p=(n=a.getNamedItem("collidable"))?"false"!=n.value:p,g=(n=a.getNamedItem("state"))?n.value:g;for(var m=new e(o,r,h,l,u,c,d,f,p),y=i.getElementsByTagName("animation"),v=0;v<y.length;v++){var w=t.parseAnimation(y[v],s);m.addAnimation(w),null==g&&(g=w.name)}if(0==y.length){var x=t.assets[o];x&&"graphic"==x.type&&(m.addAnimation(new t.Animation("image",x)),g="image")}return m.startAnimation(g),m},t.Sprite=e,t}(Sburb||{}),Sburb=function(t){return t.Fighter=function(e,i,s,n,a){t.Sprite.call(this,e,i,s,n,a,null,null,t.Sprite.prototype.MG_DEPTHING,!0),this.accel=1.5,this.decel=1,this.friction=.87,this.vx=0,this.vy=0,this.facing="Right"},t.Fighter.prototype=new t.Sprite,t.Fighter.prototype.update=function(e){this.tryToMove(e),t.Sprite.prototype.update.call(this,e),this.animation.flipX="Left"==this.facing},t.Fighter.prototype.handleInputs=function(e){var i=!1;e[t.Keys.down]||e[t.Keys.s]?(this.moveDown(),i=!0):(e[t.Keys.up]||e[t.Keys.w])&&(this.moveUp(),i=!0),e[t.Keys.left]||e[t.Keys.a]?(this.moveLeft(),i=!0):(e[t.Keys.right]||e[t.Keys.d])&&(this.moveRight(),i=!0),(e[t.Keys.space]||e[t.Keys.enter]||e[t.Keys.ctrl])&&this.attack(),i||this.idle()},t.Fighter.prototype.idle=function(){"walk"==this.state&&this.startAnimation("idle")},t.Fighter.prototype.walk=function(){"idle"==this.state&&this.startAnimation("walk")},t.Fighter.prototype.attack=function(){this.startAnimation("attack")},t.Fighter.prototype.moveUp=function(){this.walk(),this.vy-=this.accel},t.Fighter.prototype.moveDown=function(){this.walk(),this.vy+=this.accel},t.Fighter.prototype.moveLeft=function(){this.walk(),this.vx-=this.accel,this.facing="Left"},t.Fighter.prototype.moveRight=function(){this.walk(),this.vx+=this.accel,this.facing="Right"},t.Fighter.prototype.moveNone=function(){},t.Fighter.prototype.becomePlayer=function(){},t.Fighter.prototype.becomeNPC=function(){},t.Fighter.prototype.getActionQueries=function(){var t=[];return t},t.Fighter.prototype.collides=function(t,e,i){if(!this.width||!t.width)return!1;var s=this.x+(e?e:0),n=this.y+(i?i:0),a=this.width/2,o=this.height/2,r=t.x,h=t.y,l=t.width/2,u=t.height/2,c=r-s,d=h-n;return Math.sqrt(c*c/l/a+d*d/u/o)<2},t.Fighter.prototype.getBoundaryQueries=function(t,e){for(var i=this.x+(t?t:0),s=this.y+(e?e:0),n={},a=8,o=2*Math.PI/a,r=0,h=0;r<a;r++,h+=o)n[r]={x:i+Math.cos(h)*this.width/2,y:s+Math.sin(h)*this.height/2};return n},t.Fighter.prototype.tryToMove=function(t){this.vx*=this.friction,this.vy*=this.friction,Math.abs(this.vx)<this.decel&&(this.vx=0),Math.abs(this.vy)<this.decel&&(this.vy=0);var e,i=this.vx,s=this.vy,n=t.getMoveFunction(this),a=!1;n&&(l=n(i,s),i==l.x&&s==l.y||(a=!0),i=l.x,s=l.y);var o=i,r=s;this.x+=i,this.y+=s;var h=t.collides(this);if(h){for(var u=0,c=0,d=Math.atan2(this.y-h.y,this.x-h.x),f=Math.cos(d),p=Math.sin(d);this.collides(h,u,c);)u-=.1*(o-f),c-=.1*(r-p);if(t.collides(this,u,c))return this.x-=o,this.y-=r,!1;this.x+=u,this.y+=c,o+=u,r+=c;var d=Math.atan2(this.y-h.y,this.x-h.x);this.vx+=u,this.vy+=c,this.vx*=.9,this.vy*=.9}for(var g=t.isInBoundsBatch(this.getBoundaryQueries()),m=8,y=!1,v=0,w=0,x=2*Math.PI/m,e=0,d=0;e<m;e++,d+=x){var b=g[e];b||(v+=Math.cos(d),w+=Math.sin(d),y=!0)}if(y){for(var u=0,c=0,d=Math.atan2(w,v),f=Math.cos(d),p=Math.sin(d),S=0;!t.isInBounds(this,u,c)&&S<20;)u-=2*f,c-=2*p,S++;if(S>=20||t.collides(this,u,c))return console.log(u,c),this.x-=o,this.y-=r,!1;this.x+=u,this.y+=c,o+=u,r+=c,this.vx+=u,this.vy+=c,this.vx*=.9,this.vy*=.9}return!0},t.Fighter.prototype.serialize=function(e){var i=0;for(var s in this.animations)this.animations.hasOwnProperty(s)&&i++;e=e.concat("<fighter "+t.serializeAttributes(this,"name","x","y","width","height","facing")+(i>1?"state='"+this.state+"' ":"")+">");for(var n in this.animations)this.animations.hasOwnProperty(n)&&(e=this.animations[n].serialize(e));for(var a=0;a<this.actions.length;a++)e=this.actions[a].serialize(e);return e=e.concat("</fighter>")},t.parseFighter=function(e,i){var s,n=e.attributes,a=null,o=0,r=0,h=0,l=0,u=null;a=(s=n.getNamedItem("name"))?s.value:a,o=(s=n.getNamedItem("x"))?parseInt(s.value):o,r=(s=n.getNamedItem("y"))?parseInt(s.value):r,h=(s=n.getNamedItem("width"))?parseInt(s.value):h,l=(s=n.getNamedItem("height"))?parseInt(s.value):l,u=(s=n.getNamedItem("state"))?s.value:u;var c=(s=n.getNamedItem("facing"))?s.value:"Right",d=new t.Fighter(a,o,r,h,l);d.facing=c;for(var f=e.getElementsByTagName("animation"),p=0;p<f.length;p++){var g=t.parseAnimation(f[p],i);d.addAnimation(g),null==u&&(u=g.name)}return d.startAnimation(u),d},t}(Sburb||{}),Sburb=function(t){return t.Character=function(e,i,s,n,a,o,r,h,l,u,c){t.Sprite.call(this,e,i,s,n,a,null,null,t.Sprite.prototype.MG_DEPTHING,!0),this.speed=12,this.vx=0,this.vy=0,this.facing="Front",this.npc=!0,this.spriteType="character",this.following=null,this.followBuffer=null,this.follower=null,this.lastLeaderPos=null,this.handledInput=-1,this.oldX=0,this.oldY=0,c?this.bootstrap=!0:(h="number"==typeof h?h:n,l="number"==typeof l?l:a,this.addAnimation(new t.Animation("idleFront",u,o,r,h,l,0,1,2)),this.addAnimation(new t.Animation("idleRight",u,o,r,h,l,1,1,2)),this.addAnimation(new t.Animation("idleBack",u,o,r,h,l,2,1,2)),this.addAnimation(new t.Animation("idleLeft",u,o,r,h,l,3,1,2)),this.addAnimation(new t.Animation("walkFront",u,o,r,h,l,4,2,4)),this.addAnimation(new t.Animation("walkRight",u,o,r,h,l,6,2,4)),this.addAnimation(new t.Animation("walkBack",u,o,r,h,l,8,2,4)),this.addAnimation(new t.Animation("walkLeft",u,o,r,h,l,10,2,4)),this.startAnimation("walkFront")),this.becomeNPC()},t.Character.prototype=new t.Sprite,t.Character.prototype.followBufferLength=6,t.Character.prototype.update=function(e){this.handleFollowing(e),this.handleInput>0&&(--this.handleInput,0==this.handleInput&&moveNone()),this.tryToMove(this.vx,this.vy,e),t.Sprite.prototype.update.call(this,e)},t.Character.prototype.handleFollowing=function(t){if(this.following){
this.following.isNPC()&&!this.isNPC()?(this.becomeNPC(),this.collidable=!0,this.walk()):!this.following.isNPC()&&this.isNPC()&&(this.becomePlayer(),this.collidable=!1),this.following.x==this.lastLeaderPos.x&&this.following.y==this.lastLeaderPos.y||(this.followBuffer.push({x:this.following.x,y:this.following.y}),this.lastLeaderPos.x=this.following.x,this.lastLeaderPos.y=this.following.y);for(var e=null;this.followBuffer.length>this.followBufferLength;){e=this.followBuffer[0];var i,s=!1,n=t.getInverseMoveFunction(this);if(i=n?n(e.x-this.x,e.y-this.y):{x:e.x-this.x,y:e.y-this.y},Math.abs(i.x)>=this.speed/1.9&&(i.x>0?this.moveRight():this.moveLeft(),s=!0),Math.abs(i.y)>=this.speed/1.9)i.y>0?this.moveDown(s):this.moveUp(s);else if(!s){this.followBuffer.splice(0,1);continue}break}this.followBuffer.length<=this.followBufferLength&&!this.following.isNPC()&&(e&&(this.x=e.x,this.y=e.y),this.moveNone())}},t.Character.prototype.moveUp=function(t){t?(this.vx*=2/3,this.vy=2*-this.speed/3):(this.facing="Back",this.walk(),this.vx=0,this.vy=-this.speed)},t.Character.prototype.moveDown=function(t){t?(this.vx*=2/3,this.vy=2*this.speed/3):(this.facing="Front",this.walk(),this.vx=0,this.vy=this.speed)},t.Character.prototype.moveLeft=function(){this.facing="Left",this.walk(),this.vx=-this.speed,this.vy=0},t.Character.prototype.moveRight=function(){this.facing="Right",this.walk(),this.vx=this.speed,this.vy=0},t.Character.prototype.moveNone=function(){4==this.animations.walkFront.frameInterval&&(this.idle(),this.vx=0,this.vy=0)},t.Character.prototype.walk=function(){this.startAnimation("walk"+this.facing)},t.Character.prototype.idle=function(){this.startAnimation("idle"+this.facing)},t.Character.prototype.becomeNPC=function(){this.animations.walkFront.frameInterval=12,this.animations.walkBack.frameInterval=12,this.animations.walkLeft.frameInterval=12,this.animations.walkRight.frameInterval=12},t.Character.prototype.becomePlayer=function(){this.animations.walkFront.frameInterval=4,this.animations.walkBack.frameInterval=4,this.animations.walkLeft.frameInterval=4,this.animations.walkRight.frameInterval=4},t.Character.prototype.handleInputs=function(e,i){var s=-1,n=-1,a=-1,o=-1,r=-.5;s=Math.max(i.indexOf(t.Keys.down),i.indexOf(t.Keys.s)),n=Math.max(i.indexOf(t.Keys.up),i.indexOf(t.Keys.w)),a=Math.max(i.indexOf(t.Keys.left),i.indexOf(t.Keys.a)),o=Math.max(i.indexOf(t.Keys.right),i.indexOf(t.Keys.d));var h=Math.max(a,o,r),l=!0;a==h?this.moveLeft():o==h?this.moveRight():l=!1;var h=Math.max(n,s,r),u=!0;s==h?this.moveDown(l):n==h?this.moveUp(l):u=!1,l||u||this.moveNone(),this.handledInput=2},t.Character.prototype.tryToMove=function(e,i,s){var n=s.getMoveFunction(this),a=!1;n&&(l=n(e,i),e==l.x&&i==l.y||(a=!0),e=l.x,i=l.y),0==e&&0==i||(this.oldX=this.x,this.oldY=this.y);for(var o=t.Stage.scaleX,r=t.Stage.scaleY;Math.abs(e)>=o||Math.abs(i)>=r;){var h=0,u=0;if(Math.abs(e)>=o&&(h=Math.round(o*e/Math.abs(e)),this.x+=h,e-=h),Math.abs(i)>=r&&(u=Math.round(r*i/Math.abs(i)),this.y+=u,i-=u),!this.following){var c;if(c=s.collides(this)){var d=!1;if(0!=h&&(this.collides(c,0,r)?this.collides(c,0,-r)||(u-=r,this.y-=r,d=!0):(u+=r,this.y+=r,d=!0)),d||0==u||(this.collides(c,o,0)?this.collides(c,-o,0)||(h-=o,this.x-=o,d=!0):(h+=o,this.x+=o,d=!0)),!d||s.collides(this))return this.x-=h,this.y-=u,!1}if(!s.isInBounds(this)){var d=!1;if(0!=h&&(s.isInBounds(this,0,r)?(u+=r,this.y+=r,d=!0):s.isInBounds(this,0,-r)&&(u-=r,this.y-=r,d=!0)),d||0==u||(s.isInBounds(this,o,0)?(h+=o,this.x+=o,d=!0):s.isInBounds(this,-o,0)&&(h-=o,this.x-=o,d=!0)),!d||s.collides(this))return this.x-=h,this.y-=u,!1}}}return!0},t.Character.prototype.follow=function(t){for(;null!=t.follower;)t=t.follower;this.following=t,t.follower=this,this.followBuffer=[],this.lastLeaderPos={},this.collidable=!1},t.Character.prototype.unfollow=function(){this.following&&(this.following.follower=this.follower,this.follower&&(this.follower.following=this.following,this.follower.followBuffer=[]),this.following=null,this.follower=null,this.lastLeaderPos=null,this.collidable=!0,this.becomeNPC())},t.Character.prototype.getActionQueries=function(){var t=[];return t.push({x:this.x,y:this.y}),"Front"==this.facing?(t.push({x:this.x,y:this.y+(this.height/2+15)}),t.push({x:this.x-this.width/2,y:this.y+(this.height/2+15)}),t.push({x:this.x+this.width/2,y:this.y+(this.height/2+15)})):"Back"==this.facing?(t.push({x:this.x,y:this.y-(this.height/2+15)}),t.push({x:this.x-this.width/2,y:this.y-(this.height/2+15)}),t.push({x:this.x+this.width/2,y:this.y-(this.height/2+15)})):"Right"==this.facing?(t.push({x:this.x+(this.width/2+15),y:this.y}),t.push({x:this.x+(this.width/2+15),y:this.y+this.height/2}),t.push({x:this.x+(this.width/2+15),y:this.y-this.height/2})):"Left"==this.facing&&(t.push({x:this.x-(this.width/2+15),y:this.y}),t.push({x:this.x-(this.width/2+15),y:this.y+this.height/2}),t.push({x:this.x-(this.width/2+15),y:this.y-this.height/2})),t},t.Character.prototype.serialize=function(t){t=t.concat("\n<character name='"+this.name+"' x='"+this.x+"' y='"+this.y+"' width='"+this.width+"' height='"+this.height+"' state='"+this.state+"' facing='"+this.facing),t=this.bootstrap?t.concat("' bootstrap='true"):t.concat("' sx='"+this.animations.walkFront.x+"' sy='"+this.animations.walkFront.y+"' sWidth='"+this.animations.walkFront.colSize+"' sHeight='"+this.animations.walkFront.rowSize+"' sheet='"+this.animations.walkFront.sheet.name),this.following&&(t=t.concat("' following='"+this.following.name)),this.follower&&(t=t.concat("' follower='"+this.follower.name)),t=t.concat("'>");for(var e in this.animations)if(this.animations.hasOwnProperty(e)){var i=this.animations[e];(this.bootstrap||i.name.indexOf("idle")==-1&&i.name.indexOf("walk")==-1)&&(t=i.serialize(t))}for(var s=0;s<this.actions.length;s++)t=this.actions[s].serialize(t);return t=t.concat("\n</character>")},t.Character.prototype.isNPC=function(){return 12==this.animations.walkFront.frameInterval},t.parseCharacter=function(e,i){var s=e.attributes,n=new t.Character(s.getNamedItem("name").value,s.getNamedItem("x")?parseInt(s.getNamedItem("x").value):0,s.getNamedItem("y")?parseInt(s.getNamedItem("y").value):0,parseInt(s.getNamedItem("width").value),parseInt(s.getNamedItem("height").value),s.getNamedItem("sx")?parseInt(s.getNamedItem("sx").value):0,s.getNamedItem("sy")?parseInt(s.getNamedItem("sy").value):0,parseInt(s.getNamedItem("sWidth").value),parseInt(s.getNamedItem("sHeight").value),i[s.getNamedItem("sheet").value]),a=s.getNamedItem("following");if(a){var o=t.sprites[a.value];o&&n.follow(o)}var a=s.getNamedItem("follower");if(a){var r=t.sprites[a.value];r&&r.follow(n)}for(var h=e.getElementsByTagName("animation"),l=0;l<h.length;l++){var u=t.parseAnimation(h[l],i);n.addAnimation(u)}return n.startAnimation(s.getNamedItem("state").value),n.facing=s.getNamedItem("facing").value,n},t}(Sburb||{}),Sburb=function(t){return t.SpriteButton=function(e,i,s,n,a,o,r){t.Sprite.call(this,e,i,s,n,a),this.pressed=!1,this.mousePressed=!1,this.clicked=!1,this.action?r:null;for(var h=0;h<o.width/this.width*(o.height/this.height);h++)this.addAnimation(new t.Animation("state"+h,o,0,0,n,a,h,1,1e3));this.startAnimation("state0")},t.SpriteButton.prototype=new t.Sprite,t.SpriteButton.prototype.update=function(){t.Sprite.prototype.update.call(this),this.updateMouse()},t.SpriteButton.prototype.updateMouse=function(){var e=t.Mouse.x,i=t.Mouse.y,s=t.Mouse.down;if(this.clicked=!1,this.hitsPoint(e-this.width/2,i-this.height/2)&&(t.Stage.style.cursor="pointer"),s)this.mousePressed||(this.mousePressed=!0,this.hitsPoint(e-this.width/2,i-this.height/2)&&(this.pressed=!0));else{if(this.pressed&&this.hitsPoint(e-this.width/2,i-this.height/2)){this.clicked=!0;var n="state"+(parseInt(this.animation.name.substring(5,this.animation.name.length))+1);this.animations[n]?this.startAnimation(n):this.startAnimation("state0")}this.pressed=!1,this.mousePressed=!1}this.clicked&&this.action&&t.performAction(this.action)},t.SpriteButton.prototype.setState=function(t){this.startAnimation("state"+t)},t.SpriteButton.prototype.serialize=function(t){return t=t.concat("\n<spritebutton name='"+this.name+(this.x?"' x='"+this.x:"")+(this.y?"' y='"+this.y:"")+"' width='"+this.width+"' height='"+this.height+"' sheet='"+this.animation.sheet.name+"' >"),this.action&&(t=this.action.serialize(t)),t=t.concat("</spritebutton>")},t.parseSpriteButton=function(e){var i=e.attributes,s=t.assets[i.getNamedItem("sheet").value],n=new t.SpriteButton(i.getNamedItem("name").value,i.getNamedItem("x")?parseInt(i.getNamedItem("x").value):0,i.getNamedItem("y")?parseInt(i.getNamedItem("y").value):0,i.getNamedItem("width")?parseInt(i.getNamedItem("width").value):s.width,i.getNamedItem("width")?parseInt(i.getNamedItem("height").value):s.height,s),a=e.getElementsByTagName("action");if(a.length>0){var o=t.parseAction(a[0]);n.action=o}return n},t}(Sburb||{}),Sburb=function(t){return t.Animation=function(e,i,s,n,a,o,r,h,l,u,c,d,f,p,g,m){if(this.sheet=i,this.sliced=!!p,this.x=s?s:0,this.y=n?n:0,this.rowSize=o?o:i.height,this.colSize=a?a:i.width,this.startPos=r?r:0,this.length=h?h:1,this.curInterval=0,this.curFrame=0,this.name=e,this.loopNum="number"==typeof u?u:-1,this.curLoop=0,this.followUp=c,this.flipX=!!d,this.flipY=!!f,p){this.numRows=m,this.numCols=g,this.sheets={};for(var y=0;y<this.numCols;y++)for(var v=0;v<this.numRows;v++){var i=t.assets[this.sheet+"_"+y+"_"+v];i&&(this.sheets[y]||(this.sheets[y]={}),this.sheets[y][v]=i)}this.draw=this.drawSliced}else this.numRows=i.height/this.rowSize,this.numCols=i.width/this.colSize,this.draw=this.drawNormal;if("string"==typeof l)if(l.indexOf(":")==-1)this.frameInterval=parseInt(l);else{var w=l.split(",");this.frameIntervals={};for(var x=0;x<w.length;x++){var b=w[x].split(":");this.frameIntervals[parseInt(b[0])]=parseInt(b[1])}this.frameIntervals[0]||(this.frameIntervals[0]=1),this.frameInterval=this.frameIntervals[this.curFrame]}else this.frameInterval=l?l:1},t.Animation.prototype.nextFrame=function(){this.curFrame++,this.curFrame>=this.length&&(this.curLoop==this.loopNum?this.curFrame=this.length-1:(this.curFrame=0,this.loopNum>=0&&this.curLoop++)),this.frameIntervals&&this.frameIntervals[this.curFrame]&&(this.frameInterval=this.frameIntervals[this.curFrame])},t.Animation.prototype.update=function(){for(this.curInterval++;this.curInterval>this.frameInterval;)this.curInterval-=this.frameInterval,this.nextFrame()},t.Animation.prototype.drawNormal=function(e,i){var s=t.Stage,n=t.stage,a=s.offset?s.x:0,o=s.offset?s.y:0,r=s.width,h=s.height;this.flipX&&(a=-a-r,e=-e),this.flipY&&(o=-o-h,i=-i),e=Math.round((this.x+e)/s.scaleX)*s.scaleX,i=Math.round((this.y+i)/s.scaleY)*s.scaleY;var l=(this.startPos+this.curFrame)%this.numCols,u=Math.floor((this.startPos+this.curFrame-l)/this.numCols),c=l*this.colSize,d=u*this.rowSize,f=this.colSize,p=this.rowSize,g=e-a;if(!(g<0&&(c-=g,f+=g,e=a,c>=this.sheet.width)||(g=i-o,g<0&&(d-=g,p+=g,i=o,d>=this.sheet.height)||(g=f+e-a-r,g>0&&(f-=g),f<=0||(g=p+i-o-h,g>0&&(p-=g),p<=0))))){var m=1,y=1;this.flipX&&(m=-1),this.flipY&&(y=-1),1==m&&1==y||n.scale(m,y),n.drawImage(this.sheet,c,d,f,p,e,i,f,p),1==m&&1==y||n.scale(m,y)}},t.Animation.prototype.drawSliced=function(e,i){var s=t.Stage,n=t.stage,a=s.offset?s.x:0,o=s.offset?s.y:0,r=s.width,h=s.height;this.flipX&&(a=-a-r,e=-e),this.flipY&&(o=-o-h,i=-i),e=Math.round((this.x+e)/s.scaleX)*s.scaleX,i=Math.round((this.y+i)/s.scaleY)*s.scaleY;for(var l=Math.floor((a-e)/this.colSize),u=Math.floor((a+r-e)/this.colSize),c=Math.floor((o-i)/this.rowSize),d=Math.floor((o+h-i)/this.colSize),f=l;f<=u;f++)for(var p=c;p<=d;p++)if(this.sheets[f]&&this.sheets[f][p]){var g=this.sheets[f][p],m=0,y=0,v=g.width,w=g.height,e=this.x+f*this.colSize,i=this.y+p*this.rowSize,x=e-a;if(x<0&&(m-=x,v+=x,e=a,m>=this.colSize))continue;if(x=i-o,x<0&&(y-=x,w+=x,i=o,y>=this.rowSize))continue;if(x=v+e-a-r,x>0&&(v-=x),v<=0)continue;if(x=w+i-o-h,x>0&&(w-=x),w<=0)continue;var b=1,S=1;this.flipX&&(b=-1),this.flipY&&(S=-1),1==b&&1==S||n.scale(b,S),n.drawImage(g,m,y,v,w,e,i,v,w),1==b&&1==S||n.scale(b,S)}},t.Animation.prototype.reset=function(){this.curFrame=0,this.curInterval=0,this.curLoop=0},t.Animation.prototype.hasPlayed=function(){return this.curLoop==this.loopNum&&this.curFrame==this.length-1},t.Animation.prototype.setColSize=function(t){this.colSize=t,this.numCols=this.sheet.width/this.colSize,this.reset()},t.Animation.prototype.setRowSize=function(t){this.rowSize=t,this.numRows=this.sheet.height/this.rowSize,this.reset()},t.Animation.prototype.setSheet=function(t){this.sheet=t,this.numRows=this.sheet.height/this.rowSize,this.numCols=this.sheet.width/this.colSize,this.reset()},t.Animation.prototype.isVisuallyUnder=function(t,e){return t>=this.x&&t<=this.x+this.colSize&&e>=this.y&&e<=this.y+this.rowSize},t.Animation.prototype.clone=function(e,i){return new t.Animation(this.name,this.sheet,(e?e:0)+this.x,(i?i:0)+this.y,this.colSize,this.rowSize,this.startPos,this.length,this.frameInterval,this.loopNum,this.followUp,this.flipX,this.flipY,this.sliced,this.numCols,this.numRows)},t.Animation.prototype.serialize=function(e){var i="",s=!0;if(this.frameIntervals)for(var n in this.frameIntervals)this.frameIntervals.hasOwnProperty(n)&&(i=i+(s?"":",")+n+":"+this.frameIntervals[n],s=!1);else 1!==this.frameInterval&&(i=this.frameInterval);return e=e.concat("\n<animation "+("sheet='"+(this.sheet.name?this.sheet.name:this.sheet)+"' ")+("image"!=this.name?"name='"+this.name+"' ":"")+t.serializeAttributes(this,"x","y")+(this.rowSize!=this.sheet.height?"rowSize='"+this.rowSize+"' ":"")+(this.colSize!=this.sheet.width?"colSize='"+this.colSize+"' ":"")+t.serializeAttribute(this,"startPos")+(1!=this.length?"length='"+this.length+"' ":"")+(""!==i?"frameInterval='"+i+"' ":"")+(this.loopNum!=-1?"loopNum='"+this.loopNum+"' ":"")+t.serializeAttributes(this,"folowUp","flipX","flipY")+(this.sliced?"sliced='true' numCols='"+this.numCols+"' numRows='"+this.numRows+"' ":"")+" />")},t.parseAnimation=function(e,i){var s,n=e.attributes,a="image",o=null,r=0,h=0,l=null,u=null,c=1,d=1,f=!1,p=0,g=1,m=1,y=-1,v=null;f=(s=n.getNamedItem("sliced"))?"false"!=s.value:f,a=(s=n.getNamedItem("name"))?s.value:a,o=f?(s=n.getNamedItem("sheet"))?s.value:o:(s=n.getNamedItem("sheet"))?i[s.value]:o,r=(s=n.getNamedItem("x"))?parseInt(s.value):r,h=(s=n.getNamedItem("y"))?parseInt(s.value):h,g=(s=n.getNamedItem("length"))?parseInt(s.value):g,c=(s=n.getNamedItem("numCols"))?parseInt(s.value):c,d=(s=n.getNamedItem("numRows"))?parseInt(s.value):d,l=(s=n.getNamedItem("colSize"))?parseInt(s.value):Math.round(o.width/g),u=(s=n.getNamedItem("rowSize"))?parseInt(s.value):o.height,p=(s=n.getNamedItem("startPos"))?parseInt(s.value):p,m=(s=n.getNamedItem("frameInterval"))?s.value:m,y=(s=n.getNamedItem("loopNum"))?parseInt(s.value):y,v=(s=n.getNamedItem("followUp"))?s.value:v;var w=!!(s=n.getNamedItem("flipX"))&&"false"!=s.value,x=!!(s=n.getNamedItem("flipY"))&&"false"!=s.value;return new t.Animation(a,o,r,h,l,u,p,g,m,y,v,w,x,f,c,d)},t}(Sburb||{}),Sburb=function(t){return t.Room=function(t,e,i){this.name=t,this.width=e,this.height=i,this.sprites=[],this.effects=[],this.walkables=[],this.unwalkables=[],this.motionPaths=[],this.triggers=[],this.walkableMap=null,this.mapScale=4},t.Room.prototype.mapData=null,t.Room.prototype.blockSize=500,t.Room.prototype.addEffect=function(t){this.effects.push(t)},t.Room.prototype.addTrigger=function(t){this.triggers.push(t)},t.Room.prototype.addSprite=function(t){this.contains(t)||this.sprites.push(t)},t.Room.prototype.removeSprite=function(t){var e;for(e=0;e<this.sprites.length;e++)if(this.sprites[e]==t)return this.sprites.splice(e,1),!0;return!1},t.Room.prototype.addWalkable=function(t){this.walkables.push(t)},t.Room.prototype.addUnwalkable=function(t){this.unwalkables.push(t)},t.Room.prototype.addMotionPath=function(t,e,i,s,n,a,o){var r=new function(){this.path=t,this.xtox=e,this.xtoy=i,this.ytox=s,this.ytoy=n,this.dx=a,this.dy=o};this.motionPaths.push(r)},t.Room.prototype.removeWalkable=function(t){this.walkables.splice(this.walkables.indexOf(t),1)},t.Room.prototype.removeUnwalkable=function(t){this.unwalkables.splice(this.unwalkables.indexOf(t),1)},t.Room.prototype.removeMotionPath=function(t){for(var e=0;e<this.motionPaths.length;e++){var i=this.motionPaths[e];if(i.name==t.name)return void this.motionPaths.splice(e,1)}},t.Room.prototype.enter=function(){if(this.walkableMap){var e=t.Map,i=e.width=this.walkableMap.width,s=e.height=this.walkableMap.height,n=e.getContext("2d");n.drawImage(this.walkableMap,0,0,i,s,0,0,i,s),this.mapData=n.getImageData(0,0,i,s).data}},t.Room.prototype.exit=function(){this.effects=[],this.mapData=null},t.Room.prototype.contains=function(t){for(var e=0;e<this.sprites.length;e++)if(this.sprites[e]==t)return!0;return!1},t.Room.prototype.update=function(){var t;for(t=0;t<this.sprites.length;t++)this.sprites[t].update(this);for(t=this.effects.length-1;t>=0;t--)this.effects[t].hasPlayed()?this.effects.splice(t,1):this.effects[t].update();for(t=this.triggers.length-1;t>=0;t--)this.triggers[t].tryToTrigger()&&this.triggers.splice(t,1)},t.Room.prototype.draw=function(){this.sortDepths();for(var t=0;t<this.sprites.length;t++)this.sprites[t].draw();for(t=0;t<this.effects.length;t++)this.effects[t].draw(0,0)},t.Room.prototype.sortDepths=function(){var t,e;for(t=1,e=1;t<this.sprites.length;t++,e=t){for(var i=this.sprites[e];e>0&&i.isBehind(this.sprites[e-1]);)this.sprites[e]=this.sprites[e-1],e--;this.sprites[e]=i}},t.Room.prototype.queryActions=function(t,e,i){for(var s=[],n=0;n<this.sprites.length;n++){var a=this.sprites[n];a!=t&&a.hitsPoint(e,i)&&(s=s.concat(a.getActions(t)))}return s},t.Room.prototype.queryActionsVisual=function(t,e,i){for(var s=[],n=0;n<this.sprites.length;n++){var a=this.sprites[n];a.isVisuallyUnder(e,i)&&(s=s.concat(a.getActions(t)))}return s},t.Room.prototype.isInBounds=function(t,e,i){var s=t.getBoundaryQueries(e,i),n=this.isInBoundsBatch(s);for(var a in n)if(!n[a])return!1;return!0},t.Room.prototype.isInBoundsBatch=function(t,e){if("object"!=typeof e){e={};for(var i in t)t.hasOwnProperty(i)&&(e[i]=!1)}if(this.walkableMap)for(var s in t)if(t.hasOwnProperty(s)){var n=t[s],a=this.mapData,o=this.walkableMap.width,r=this.walkableMap.height;if(n.x<0||n.x>o*this.mapScale||n.y<0||n.y>r*this.mapScale)e[s]=!1;else{var h=4*(Math.round(n.x/this.mapScale)+Math.round(n.y/this.mapScale)*o);e[s]=!!a[h]}}for(var l=0;l<this.walkables.length;l++)this.walkables[l].queryBatchPos(t,e);for(var l=0;l<this.unwalkables.length;l++)this.unwalkables[l].queryBatchNeg(t,e);return e},t.Room.prototype.getMoveFunction=function(t){var e=this.getMotionPath(t);if(e)return function(t,i){var s,n;return s=t*e.xtox+i*e.ytox+e.dx,n=t*e.xtoy+i*e.ytoy+e.dy,{x:s,y:n}}},t.Room.prototype.getInverseMoveFunction=function(t){var e=this.getMotionPath(t);if(e)return function(t,i){t-=e.dx,i-=e.dy;var s,n,a=e.xtox*e.ytoy-e.xtoy*e.ytox;return a?(s=(t*e.ytoy-i*e.ytox)/a,n=(-t*e.xtoy+i*e.xtox)/a,{x:s,y:n}):{x:0,y:0}}},t.Room.prototype.getMotionPath=function(t){for(i=0;i<this.motionPaths.length;i++){var e=this.motionPaths[i];if(e.path.query(t))return e}return null},t.Room.prototype.collides=function(t,e,i){for(var s=0;s<this.sprites.length;s++){var n=this.sprites[s];if(n.collidable&&t!=n&&t.collides(n,e,i))return n}return null},t.Room.prototype.serialize=function(t){t=t.concat("\n<room name='"+this.name+"' width='"+this.width+"' height='"+this.height+(this.walkableMap?"' walkableMap='"+this.walkableMap.name:"")+(4!=this.mapScale?"' mapScale='"+this.mapScale:"")+"' >"),t=t.concat("\n<paths>");for(var e=0;e<this.walkables.length;e++){var i=this.walkables[e];t=t.concat("\n<walkable path='"+i.name+"'/>")}for(var e=0;e<this.unwalkables.length;e++){var s=this.unwalkables[e];t=t.concat("\n<unwalkable path='"+s.name+"'/>")}for(var e=0;e<this.motionPaths.length;e++){var n=this.motionPaths[e];t=t.concat("\n<motionpath path='"+n.path.name+"' xtox='"+n.xtox+"' xtoy='"+n.xtoy+"' ytox='"+n.ytox+"' ytoy='"+n.ytoy+"' dx='"+n.dx+"' dy='"+n.dy+"'/>")}t=t.concat("\n</paths>"),t=t.concat("\n<triggers>");for(var e=0;e<this.triggers.length;e++)t=this.triggers[e].serialize(t);t=t.concat("\n</triggers>");for(var e=0;e<this.sprites.length;e++)t=this.sprites[e].serialize(t);return t=t.concat("\n</room>")},t.parseRoom=function(e,i,s){var n=e.attributes,a=new t.Room(n.getNamedItem("name").value,n.getNamedItem("width")?parseInt(n.getNamedItem("width").value):0,n.getNamedItem("height")?parseInt(n.getNamedItem("height").value):0),o=n.getNamedItem("mapScale");o&&(a.mapScale=parseInt(o.value));var r=n.getNamedItem("walkableMap");r&&(a.walkableMap=i[r.value],a.width||(a.width=a.walkableMap.width*a.mapScale),a.height||(a.height=a.walkableMap.height*a.mapScale)),t.serialLoadRoomSprites(a,e.getElementsByTagName("sprite"),s),t.serialLoadRoomSprites(a,e.getElementsByTagName("character"),s),t.serialLoadRoomSprites(a,e.getElementsByTagName("fighter"),s);var h=e.getElementsByTagName("paths");h.length>0&&t.serialLoadRoomPaths(a,h,i);var l=e.getElementsByTagName("triggers");return l.length>0&&t.serialLoadRoomTriggers(a,l,s),a},t}(Sburb||{});!function(){function t(t,e){return this.slice(t,e)}function e(t,e){arguments.length<2&&(e=0);for(var i=0,s=t.length;i<s;++i,++e)this[e]=255&t[i]}function i(i){var s;if("number"==typeof i){s=new Array(i);for(var n=0;n<i;++n)s[n]=0}else s=i.slice(0);return s.subarray=t,s.buffer=s,s.byteLength=s.length,s.set=e,"object"==typeof i&&i.buffer&&(s.buffer=i.buffer),s}try{new Uint8Array(1);return}catch(t){}window.Uint8Array=i,window.Uint32Array=i,window.Int32Array=i}();var Sburb=function(t){return t.FontEngine=function(t){this.font="bold 14px SburbFont",this.color="#000000",this.text="string"==typeof t?t:"",this.x=0,this.y=0,this.width=999999,this.height=999999,this.start=0,this.end=999999,this.lines=[],this.lineHeight=17,this.charWidth=8,this.align="left",this.formatted=!0,this.formatQueue=[]},t.FontEngine.prototype.prefixColours={aa:"#a10000",aradia:"#a10000",ac:"#416600",nepeta:"#416600",ag:"#005682",vriska:"#005682",at:"#a15000",tavros:"#a15000",ca:"#6a006a",eridan:"#6a006a",cc:"#77003c",feferi:"#77003c",cg:"#626262",karkat:"#626262",ct:"#000056",equius:"#000056",ga:"#008141",kanaya:"#008141",kanaya2:"#008141",gc:"#008282",terezi:"#008282",ta:"#a1a100",sollux:"#a1a100",tc:"#2b0057",gamzee:"#6c00da",dave:"#e00707",meenah:"#77003c",rose:"#b536da",aranea:"#005682",kankri:"#ff0000",porrim:"#008141",latula:"#008282",cronus:"#6a006a",mituna:"#a1a100",kurloz:"#6c00da",meulin:"#416600",rufioh:"#a15000",horuss:"#000056",damara:"#a10000"},t.FontEngine.prototype.setStyle=function(t,e,i,s){this.font="string"==typeof t?t:this.font,this.color="string"==typeof e?e:this.color,this.lineHeight="number"==typeof i?i:this.lineHeight,this.charWidth="number"==typeof s?s:this.charWidth,this.parseText()},t.FontEngine.prototype.setFormatted=function(t){this.formatted=t},t.FontEngine.prototype.setText=function(t){this.text=t,this.parseEverything()},t.FontEngine.prototype.setAlign=function(t){this.align=t},t.FontEngine.prototype.showSubText=function(t,e){this.start="number"==typeof t?t:this.start,this.end="number"==typeof e?e:this.end},t.FontEngine.prototype.setDimensions=function(t,e,i,s){this.x="number"==typeof t?t:this.x,this.y="number"==typeof e?e:this.y,this.width="number"==typeof i?i:this.width,this.height="number"==typeof s?s:this.height,this.parseText()},t.FontEngine.prototype.parseEverything=function(){this.parseFormatting(),this.parseText()},t.FontEngine.prototype.parseText=function(){t.stage.font=this.font,this.lines=[];var e=0,i=0,s=0;for(e=0;e<this.text.length;e++){if(" "==this.text.charAt(e))i=e;else if("\\"==this.text.charAt(e)&&"n"==this.text.charAt(e+1)){this.lines.push(this.text.substring(s,e)),s=e+2,i=s;continue}t.stage.measureText(this.text.substring(s,e+1)).width>this.width&&(s==i?(this.lines.push(this.text.substring(s,e)),s=e,i=e):(this.lines.push(this.text.substring(s,i)),s=i+1,i=s))}this.lines.push(this.text.substring(s,e))},t.FontEngine.prototype.parseFormatting=function(){this.formatQueue=[],this.formatted&&(this.escaped={},this.parsePrefixes(),this.parseEscapes(),this.parseUnderlines(),this.parseColors())},t.FontEngine.prototype.parseEscapes=function(){var t,e=0;do{if(t=this.text.indexOf("/",e),t<this.text.length-1&&t>=0){var i=this.text.charAt(t+1);if("/"==i)e=t+1;else{var s=this.escaped[i];s||(s=this.escaped[i]={});for(var n=0,a=0;a<t;a++)this.text.charAt(a)==i&&n++;s[n+1]=!0}}this.text=this.text.substring(0,t)+this.text.substring(t+1,this.text.length)}while(t>=0)},t.FontEngine.prototype.parsePrefixes=function(){var t,e=this.text.split(" ",1)[0];"!"!=e&&(t=e.indexOf("_")>=0?e.substring(0,this.text.indexOf("_")):e.substring(0,2),this.parsePrefix(t)),this.text=this.text.substring(e.length,this.text.length).trim()},t.FontEngine.prototype.parseUnderlines=function(){for(var e=0,i=0,s=0;;){for(;;){if(s++,i=this.text.indexOf("_",e),!this.escaped._||!this.escaped._[s])break;e=i+1}if(i==-1)break;for(var n=!1,a=this.formatQueue.length-1;a>=0;a--)if("underline"==this.formatQueue[a].type&&999999==this.formatQueue[a].maxIndex){this.formatQueue[a].maxIndex=i,n=!0;break}n||this.addToFormatQueue(new t.FormatRange(i,999999,"underline")),this.text=this.text.substring(0,i)+this.text.substring(i+1,this.text.length),this.realignFormatQueue(i,1)}},t.FontEngine.prototype.parseColors=function(){for(var e=0,i=0,s=0;;){for(;;){if(s++,i=this.text.indexOf("#",e),!this.escaped["#"]||!this.escaped["#"][s])break;e=i+1}if(i==-1)break;if(this.text.indexOf("##",e)==i){for(var n=this.formatQueue.length-1;n>=0;n--)if("colour"==this.formatQueue[n].type&&999999==this.formatQueue[n].maxIndex){this.formatQueue[n].maxIndex=i;break}s++,this.text=this.text.substring(0,i)+this.text.substring(i+2,this.text.length),this.realignFormatQueue(i,2)}else this.addToFormatQueue(new t.FormatRange(i,999999,"colour","#"+this.text.substring(i+1,i+7))),this.text=this.text.substring(0,i)+this.text.substring(i+7,this.text.length),this.realignFormatQueue(i,7)}},t.FontEngine.prototype.addToFormatQueue=function(t){for(var e=this.formatQueue.length,i=0;i<this.formatQueue.length;i++)if(this.formatQueue[i].minIndex>t.minIndex){e=i;break}this.formatQueue.splice(e,0,t)},t.FontEngine.prototype.realignFormatQueue=function(t,e){for(var i=0;i<this.formatQueue.length;i++){var s=this.formatQueue[i];s.maxIndex>t&&999999!=s.maxIndex&&(s.maxIndex-=e),s.minIndex>t&&(s.minIndex-=e)}},t.FontEngine.prototype.parsePrefix=function(e){this.formatQueue.push(new t.FormatRange(0,this.text.length,"colour",this.prefixColouration(e)))},t.FontEngine.prototype.prefixColouration=function(t){return this.prefixColours[t.toLowerCase()]?this.prefixColours[t.toLowerCase()]:"#000000"},t.FontEngine.prototype.nextBatch=function(){return this.realignFormatQueue(-1,this.batchLength()),this.lines.splice(0,Math.min(this.lines.length,Math.floor(this.height/this.lineHeight))),this.lines.length},t.FontEngine.prototype.onLastBatch=function(){return Math.floor(this.height/this.lineHeight)>=this.lines.length},t.FontEngine.prototype.draw=function(){var e,i,s,n,a,o,r=0,h=0,l=[];e=0,i=0;for(var u=0;e<Math.floor(this.height/this.lineHeight)&&e<this.lines.length;){t.stage.save(),t.stage.textBaseline="top",t.stage.textAlign=this.align,o=this.lines[e];var c=this.font,d=this.color,f=!1;a=o.length,h<this.formatQueue.length&&this.formatQueue[h].minIndex<=i+r&&(l.push(this.formatQueue[h]),h++);for(var p=l.length-1;p>=0;p--)l[p].maxIndex<=i+r&&l.splice(p,1);for(var p=0;p<l.length;p++)"colour"==l[p].type?d=l[p].extra:"underline"==l[p].type?f=!0:"italic"==l[p].type&&(c="italic "+this.font);h<this.formatQueue.length&&this.formatQueue[h].minIndex<i+o.length&&this.formatQueue[h].minIndex<this.end&&(a=Math.min(a,this.formatQueue[h].minIndex-i));for(var p=0;p<l.length;p++)l[p].maxIndex<this.end&&(a=Math.min(a,l[p].maxIndex-i));a!=o.length?(s=r,n=a,r+=n-s):(n=i+o.length<=this.end?o.length:this.end-i,i+r>=this.start?s=r:i+o.length>=this.start?(s=this.start-i+r,u+=t.stage.measureText(o.substring(r,s)).width):(s=r,n=r),r=-1);var g=n-s;if(g>0){var m=this.x+u,y=this.y+e*this.lineHeight;t.stage.font=c,t.stage.strokeStyle=t.stage.fillStyle=d,t.stage.fillText(o.substring(s,n),m,y),u+=t.stage.measureText(o.substring(s,n)).width,f&&s<n&&(.6!=t.stage.lineWidth&&(t.stage.lineWidth=.6),"square"!=t.stage.lineCap&&(t.stage.lineCap="square"),t.stage.beginPath(),t.stage.moveTo(m,y+this.lineHeight-3),t.stage.lineTo(m+g*this.charWidth,y+this.lineHeight-3),t.stage.closePath(),t.stage.stroke())}r==-1&&(i+=this.lines[e].length+1,r=0,u=0,e++),t.stage.restore()}},t.FontEngine.prototype.isShowingAll=function(){return this.end>=this.batchLength()},t.FontEngine.prototype.batchLength=function(){var t,e=0;for(t=0;t<Math.floor(this.height/this.lineHeight)&&t<this.lines.length;t++)e+=this.lines[t].length;return e},t.FontEngine.prototype.showAll=function(){this.end=this.batchLength()+1},t.FormatRange=function(t,e,i,s){this.minIndex=t,this.maxIndex=e,this.type=i,this.extra="string"==typeof s?s:""},t}(Sburb||{}),Sburb=function(t){function e(e){if(!e)return"";for(var i=0;i<e.childNodes.length;i++){var s=e.childNodes[i];if("args"==s.tagName){if(s.attributes){var n=s.attributes.getNamedItem("body");if(n&&n.value&&t.assetManager.isLoaded(n.value))return t.assets[n.value]}for(var a=0;a<s.childNodes.length;a++)if(s.childNodes[a].firstChild){serializer=new XMLSerializer;for(var o="",r=0;r<s.childNodes.length;r++)o+=serializer.serializeToString(s.childNodes[r]);return o}return"undefined"!=typeof s.textContent?s.textContent:s.firstChild.nodeValue}}return"undefined"!=typeof e.textContent?e.textContent:e.firstChild.nodeValue}return t.Action=function(t,e,i,s,n,a,o,r,h,l){this.sprite=s?s:null,this.name=i?i:null,this.command=t,this._info=e,this.followUp=n?n:null,this.noWait=!!a&&a,this.noDelay=!!o&&o,this.soft=!!h&&h,"true"==l?this.silent=!0:this.silent=!!l&&l,this.times=r?r:1},t.Action.prototype.info=function(){if(this._info){if("string"==typeof this._info)return this._info;if(this._info.text)return this._info.text}return""},t.Action.prototype.clone=function(){return new t.Action(this.command,this._info,this.name,this.sprite,this.followUp,this.noWait,this.noDelay,this.times,this.soft,this.silent)},t.Action.prototype.serialize=function(t){return t=t.concat("\n<action command='"+this.command+(this.sprite?"' sprite='"+this.sprite:"")+(this.name?"' name='"+escape(this.name):"")+(this.noWait?"' noWait='"+this.noWait:"")+(this.noDelay?"' noDelay='"+this.noDelay:"")+(this.soft?"' soft='"+this.soft:"")+(this.silent?"' silent='"+this.silent:"")+(1!=this.times?"' times='"+this.times:"")+"'>"),"string"==typeof this._info?t=t.concat("<args>"+escape(this._info.trim())+"</args>"):this._info.name&&(t=t.concat('<args body="'+this._info.name+'" />')),this.followUp&&(t=this.followUp.serialize(t)),t=t.concat("</action>")},t.parseAction=function(i){var s=null,n=null,a=null;do{var o=i.attributes;o.getNamedItem("sprite")&&"null"!=o.getNamedItem("sprite").value&&(s=o.getNamedItem("sprite").value);var r=o.getNamedItem("times")||o.getNamedItem("loops")||o.getNamedItem("for"),h=i.firstChild?e(i):"";"string"==typeof h&&(h=unescape(h).trim());var l=new t.Action(o.getNamedItem("command").value,h,o.getNamedItem("name")?unescape(o.getNamedItem("name").value):null,s,null,!!o.getNamedItem("noWait")&&"true"==o.getNamedItem("noWait").value,!!o.getNamedItem("noDelay")&&"true"==o.getNamedItem("noDelay").value,r?parseInt(r.value):1,!!o.getNamedItem("soft")&&"true"==o.getNamedItem("soft").value,!!o.getNamedItem("silent")&&o.getNamedItem("silent").value);a&&(a.followUp=l),n||(n=l),a=l;var u=i;i=null;for(var c=0;c<u.childNodes.length;c++){var d=u.childNodes[c];if("action"==d.nodeName){i=d;break}}if(!i)break}while(i);return n},t}(Sburb||{}),Sburb=function(t){function e(t){var e=t.split(",");return e.map(function(t){return t.trim()}),e}var i={};return i.spriteProperty=function(i){var s,n=e(i),a=n[2];a.indexOf(">")>-1&&(s=">")||a.indexOf("GREATER")>-1&&(s="GREATER")?this.trigger=function(t,e,i){return t[e]>i}:a.indexOf("<")>-1&&(s="<")||a.indexOf("LESS")>-1&&(s="LESS")?this.trigger=function(t,e,i){
return t[e]<i}:a.indexOf("!=")>-1?(s="!=",this.trigger=function(t,e,i){return t[e]!=i}):a.indexOf("=")>-1&&(s="=",this.trigger=function(t,e,i){return t[e]==i});var o=a.split(s),r=o[0].trim(),h=o[1].trim();this.reset=function(){"char"==n[1]?this.entity=n[1]:this.entity=t.sprites[n[1]]},this.checkCompletion=function(){var e=this.entity;return"char"==this.entity&&(e=t.char),this.trigger(e,r,h)}},i.inBox=function(i){var s=e(i),n=parseInt(s[2]),a=parseInt(s[3]),o=parseInt(s[4]),r=parseInt(s[5]);this.reset=function(){"char"==s[1]?this.entity=s[1]:this.entity=t.sprites[s[1]]},this.checkCompletion=function(){var e=this.entity;return"char"==this.entity&&(e=t.char),e.x>=n&&e.y>=a&&e.x<=n+o&&e.y<=a+r}},i.inBox2=function(t){var s=e(t),n=parseInt(s[2]),a=parseInt(s[3]),o=parseInt(s[4]),r=parseInt(s[5]),h=Math.min(n,o),l=Math.min(a,r),u=Math.abs(n-o),c=Math.abs(a-r);return new i.inBox("inBox,"+s[1]+","+h+","+l+","+u+","+c)},i.time=function(t){var i=e(t);this.reset=function(){this.time=parseInt(i[1])},this.checkCompletion=function(){return this.time--,this.time<=0},this.serialize=function(){return"time,"+this.time}},i.played=function(i){var s=e(i);this.reset=function(){this.entity=t.sprites[s[1]]},this.checkCompletion=function(){var e=this.entity;return"char"==this.entity&&(e=t.char),e.animation.hasPlayed()}},i.movie=function(i){var s=e(i),n=parseInt(s[2]);this.reset=function(){this.movie=window.document.getElementById("movie"+s[1])},this.checkCompletion=function(){return!(!this.movie||this.movie.TotalFrames&&!(this.movie.TotalFrames()>0&&this.movie.TotalFrames()-1-this.movie.CurrentFrame()<=n))&&(t.commands.removeMovie(s[1]),!0)}},i.gameState=function(i){var s,n=e(i),a=n[1];a.indexOf(">")>-1&&(s=">")||a.indexOf("GREATER")>-1&&(s="GREATER")?this.trigger=function(e,i){return t.gameState[e]>i}:a.indexOf("<")>-1&&(s="<")||a.indexOf("LESS")>-1&&(s="LESS")?this.trigger=function(e,i){return t.gameState[e]<i}:a.indexOf("!=")>-1?(s="!=",this.trigger=function(e,i){return t.gameState[e]!=i}):a.indexOf("=")>-1&&(s="=",this.trigger=function(e,i){return t.gameState[e]==i});var o=a.split(s),r=o[0].trim(),h=o[1].trim();this.reset=function(){},this.checkCompletion=function(){return this.trigger(r,h)}},i.nudge=function(e){this.reset=function(){},this.checkCompletion=function(){return t.Keys.space||t.Mouse.down}},i.noActions=function(i){var s=e(i);this.reset=function(){},this.checkCompletion=function(){var e=s.length>0?t.getActionQueueById(s[1]):t;return!e||!e.curAction}},i.withinRange=function(i){var s=e(i),n=s[1],a=s[2],o=parseFloat(s[3]);this.reset=function(){},this.checkCompletion=function(){var e=t.parseCharacterString(n),i=t.parseCharacterString(a),s=e.x-i.x,r=e.y-i.y;return Math.sqrt(s*s+r*r)<=o}},t.events=i,t}(Sburb||{}),Sburb=function(t){function e(t){if(!t)return[];for(var e=[],i=0;i<t.childNodes.length;i++){var s=t.childNodes[i];if("args"==s.tagName){for(var n=0;n<s.childNodes.length;n++)if(s.childNodes[n].firstChild){serializer=new XMLSerializer;for(var a="",o=0;o<s.childNodes.length;o++)a+=serializer.serializeToString(s.childNodes[o]);e.push(a)}"undefined"!=typeof s.textContent?e.push(s.textContent):e.push(s.firstChild.nodeValue)}}return 0==e.length&&e.push(t.firstChild.nodeValue),e}return t.Trigger=function(e,i,s,n,a,o){"string"==typeof e&&(e=[e]),this.info=e,this.followUp=s?s:null,this.action=i?i:null,this.restart=!!n&&n,this.detonate=!!a&&a,this.operator=o?o.toUpperCase():"AND",this.waitFor=null,this.events=[];for(var r=0;r<e.length;r++){var h=this.info[r].trim(),l=h.split(","),u=l[0];this.events[r]=new t.events[u](h)}this.reset()},t.Trigger.prototype.reset=function(){for(var t=0;t<this.events.length;t++)this.events[t].reset()},t.Trigger.prototype.checkCompletion=function(){return this["operator"+this.operator]()},t.Trigger.prototype.tryToTrigger=function(){if(this.waitFor){if(!this.waitFor.checkCompletion())return;this.waitFor=null}if(this.checkCompletion()){if(this.action){var e=t.performAction(this.action);e?this.waitFor=new t.Trigger("noActions,"+e.id):this.waitFor=new t.Trigger("noActions")}return this.followUp&&this.followUp.tryToTrigger()&&(this.followUp=null),this.restart&&reset(),this.detonate}},t.Trigger.prototype.serialize=function(t){t=t.concat("\n<trigger"+(this.restart?" restart='true'":"")+(this.detonate?" detonate='true'":"")+(this.operator?" operator='"+this.operator+"'":"")+">");for(var e=0;e<this.info.length;e++)t=this.events[e].serialize?t.concat("<args>"+escape(this.events[e].serialize())+"</args>"):t.concat("<args>"+escape(this.info[e])+"</args>");return this.action&&(t=this.action.serialize(t)),this.followUp&&(t=this.followUp.serialize(t)),t=t.concat("\n</trigger>")},t.Trigger.prototype.operatorAND=function(){for(var t=!0,e=0;e<this.events.length;e++)t=t&&this.events[e].checkCompletion();return t},t.Trigger.prototype.operatorOR=function(){for(var t=!1,e=0;e<this.events.length;e++)t=t||this.events[e].checkCompletion();return t},t.Trigger.prototype.operatorXOR=function(){for(var t=!1,e=0;e<this.events.length;e++)if(this.events[e].checkCompletion()){if(t)return!1;t=!0}return t},t.Trigger.prototype.operatorNAND=t.Trigger.prototype.operatorNOT=function(){return!this.operatorAND()},t.Trigger.prototype.operatorNOR=function(){return!this.operatorOR()},t.parseTrigger=function(i){var s=null,n=null;do{for(var a=i.attributes,o=e(i),r=0;r<o.length;r++)o[r]=unescape(o[r]);var h=i.getElementsByTagName("action"),l=null,u=!1,c=!1,d=null;h.length>0&&h[0].parentNode==i&&(l=t.parseAction(h[0])),u=a.getNamedItem("restart")?"true"==a.getNamedItem("restart").value:u,c=a.getNamedItem("detonate")?"true"==a.getNamedItem("detonate").value:c,d=a.getNamedItem("operator")?a.getNamedItem("operator").value:d;var f=new t.Trigger(o,l,null,u,c,d);s||(s=f),n&&(n.followUp=f),n=f;for(var p=!1,r=0;r<i.childNodes.length;r++){var g=i.childNodes[r];if("trigger"==g.nodeName){i=g,p=!0;break}}if(!p)break}while(i);return s},t}(Sburb||{}),Sburb=function(t){function e(t){for(var e=t.split(","),i=0;i<e.length;i++)e[i]=e[i].trim();return e}function i(e){var i=[];e="<sburb>"+e+"</sburb>";for(var s=t.parseXML(e),n=0;n<s.childNodes.length;n++){var a=s.childNodes[n];"action"==a.tagName&&i.push(t.parseAction(a))}return i}function s(e){var i=[];e="<triggers>"+e+"</triggers>";for(var s=t.parseXML(e),n=0;n<s.childNodes.length;n++){var a=s.childNodes[n];"trigger"==a.tagName&&i.push(t.parseTrigger(a))}return i}var n={};n.talk=function(e){t.dialoger.startDialog(e)},n.randomTalk=function(e){t.dialoger.startDialog(e);var i=Math.floor(Math.random()*(t.dialoger.queue.length+1));i?(t.dialoger.queue=[t.dialoger.queue[i-1]],t.dialoger.nextDialog()):t.dialoger.queue=[]},n.changeRoom=function(i){var s=e(i);t.changeRoom(t.rooms[s[0]],parseInt(s[1]),parseInt(s[2])),t.loadingRoom=!1},n.changeFocus=function(i){var s=e(i);if("null"==s[0])t.focus=t.destFocus=null;else{var n=a(s[0]);t.destFocus=n}},n.teleport=function(i){n.changeRoom(i),t.playEffect(t.effects.teleportEffect,t.char.x,t.char.y);var s=e(i);t.curAction.followUp=new t.Action("playEffect","teleportEffect,"+s[1]+","+s[2],null,null,t.curAction.followUp)},n.changeChar=function(e){t.char.becomeNPC(),t.char.moveNone(),t.char.walk(),t.destFocus=t.char=t.sprites[e],t.char.becomePlayer(),t.setCurRoomOf(t.char)},n.playSong=function(i){var s=e(i);t.changeBGM(new t.BGM(t.assets[s[0]],parseFloat(s[1])))},n.becomeNPC=function(e){t.char.becomeNPC()},n.becomePlayer=function(e){t.char.becomePlayer()},n.playSound=function(e){t.playSound(new t.Sound(t.assets[e.trim()]))},n.playEffect=function(i){var s=e(i);t.playEffect(t.effects[s[0]],parseInt(s[1]),parseInt(s[2]))},n.playAnimation=n.startAnimation=function(t){var i=e(t),s=a(i[0]);s.startAnimation(i[1])},n.addAction=n.addActions=function(t){for(var s=e(t),n=t.indexOf(","),o=a(s[0]),r=t.substring(n+1,t.length),h=i(r),l=0;l<h.length;l++){var u=h[l];o.addAction(u)}},n.removeAction=n.removeActions=function(t){for(var i=e(t),s=a(i[0]),n=1;n<i.length;n++)s.removeAction(i[n])},n.presentAction=n.presentActions=function(e){var s=i(e);t.chooser.choices=s,t.chooser.beginChoosing(t.Stage.x+20,t.Stage.y+50)},n.openChest=function(e){var i=e.split(",",2),s=t.sprites[i[0].trim()],a=t.sprites[i[1].trim()];s.animations.open&&(s.startAnimation("open"),t.assets.openSound&&n.playSound("openSound")),s.removeAction(t.curAction.name);var o=i[0].length+i[1].length+2,r=e.substring(o,e.length).trim();r="@"==r.charAt(0)?r:"@! "+r;var h,l=h=new t.Action("waitFor","played,"+s.name,null,null);h=h.followUp=new t.Action("waitFor","time,13"),h=h.followUp=new t.Action("addSprite",a.name+","+t.curRoom.name,null,null,null,!0),h=h.followUp=new t.Action("moveSprite",a.name+","+s.x+","+(s.y-60),null,null,null,!0,!0),h=h.followUp=new t.Action("deltaSprite",a.name+",0,-3",null,null,null,!0,null,10),t.assets.itemGetSound&&(h=h.followUp=new t.Action("playSound","itemGetSound",null,null,null,!0,null)),h=h.followUp=new t.Action("waitFor","time,30"),h=h.followUp=new t.Action("talk",r),h=h.followUp=new t.Action("removeSprite",a.name+","+t.curRoom.name),h.followUp=t.curAction.followUp,t.performAction(l)},n.deltaSprite=function(i){var s=e(i),n=null;n="char"==s[0]?t.char:t.sprites[s[0]];var a=parseInt(s[1]),o=parseInt(s[2]);n.x+=a,n.y+=o},n.moveSprite=function(t){var i=e(t),s=a(i[0]),n=parseInt(i[1]),o=parseInt(i[2]);s.x=n,s.y=o},n.depthSprite=function(t){var i=e(t),s=a(i[0]),n=parseInt(i[1]);s.depthing=n},n.playMovie=function(i){var s=e(i);if(t.playMovie(t.assets[s[0]]),s.length>0)var a=setInterval(function(){var t=window.document.getElementById("movie"+s[0]);t&&(!t.CurrentFrame||t.CurrentFrame()>=4)&&(clearInterval(a),n.playSong(i.substring(i.indexOf(",")+1,i.length)))},10)},n.removeMovie=function(e){t.playingMovie=!1,t.draw(),document.getElementById(e).style.display="none"},n.disableControl=function(e){t.inputDisabled=!(e.trim().length>0)||new t.Trigger(e)},n.enableControl=function(e){t.inputDisabled=!1},n.waitFor=function(t){return n.disableControl(t),n.sleep(t)},n.macro=function(e){var s=i(e),n=s[0];n.silent||(n.silent=!0);var a=t.performAction(n);if(a)return new t.Trigger("noActions,"+a.id)},n.sleep=function(e){return new t.Trigger(e)},n.pauseActionQueue=n.pauseActionQueues=function(i){for(var s=e(i),n=0;n<s.length;n++){var a=t.getActionQueueById(s[n]);a&&(a.paused=!0)}},n.resumeActionQueue=n.resumeActionQueues=function(i){for(var s=e(i),n=0;n<s.length;n++){var a=t.getActionQueueById(s[n]);a&&(a.paused=!1)}},n.cancelActionQueue=n.cancelActionQueues=function(i){for(var s=e(i),n=0;n<s.length;n++)t.removeActionQueueById(s[n])},n.pauseActionQueueGroup=n.pauseActionQueueGroups=function(i){for(var s=e(i),n=0;n<s.length;n++)t.forEachActionQueueInGroup(s[n],function(t){t.paused=!0})},n.resumeActionQueueGroup=n.resumeActionQueueGroups=function(i){for(var s=e(i),n=0;n<s.length;n++)t.forEachActionQueueInGroup(s[n],function(t){t.paused=!1})},n.cancelActionQueueGroup=n.cancelActionQueueGroups=function(i){for(var s=e(i),n=0;n<s.length;n++)t.removeActionQueuesByGroup(s[n])},n.addSprite=function(i){var s=e(i),n=t.sprites[s[0]],a=t.rooms[s[1]];a.addSprite(n)},n.removeSprite=function(i){var s=e(i),n=t.sprites[s[0]],a=t.rooms[s[1]];a.removeSprite(n)},n.cloneSprite=function(t){var i=e(t),s=a(i[0]),n=i[1];s.clone(n)},n.addWalkable=function(i){var s=e(i),n=t.assets[s[0]],a=t.rooms[s[1]];a.addWalkable(n)},n.addUnwalkable=function(i){var s=e(i),n=t.assets[s[0]],a=t.rooms[s[1]];a.addUnwalkable(n)},n.addMotionPath=function(i){var s=e(i),n=t.assets[s[0]],a=t.rooms[s[7]];a.addMotionPath(n,parseFloat(s[1]),parseFloat(s[2]),parseFloat(s[3]),parseFloat(s[4]),parseFloat(s[5]),parseFloat(s[6]))},n.removeWalkable=function(i){var s=e(i),n=t.assets[s[0]],a=t.rooms[s[1]];a.removeWalkable(n)},n.removeUnwalkable=function(i){var s=e(i),n=t.assets[s[0]],a=t.rooms[s[1]];a.removeUnwalkable(n)},n.toggleVolume=function(){t.globalVolume>=1?t.globalVolume=0:t.globalVolume>=.6?t.globalVolume=1:t.globalVolume>=.3?t.globalVolume=.66:t.globalVolume=.33,t.bgm&&t.bgm.fixVolume()},n.changeMode=function(e){t.engineMode=e.trim()},n.loadStateFile=function(i){var s=e(i),n=s[0],a="true"==s[1];t.loadSerialFromXML(n,a)},n.fadeOut=function(e){t.fading=!0},n.changeRoomRemote=function(i){if(!t.loadingRoom){t.loadingRoom=!0;var s,n=e(i),a=s=new t.Action("fadeOut");s=s.followUp=new t.Action("loadStateFile",n[0]+","+!0),s=s.followUp=new t.Action("changeRoom",n[1]+","+n[2]+","+n[3]),s.followUp=t.curAction.followUp,t.performAction(a)}},n.teleportRemote=function(i){if(!t.loadingRoom){t.loadingRoom=!0,n.changeRoomRemote(i),t.playEffect(t.effects.teleportEffect,t.char.x,t.char.y);var s=e(i);t.curAction.followUp.followUp.followUp=new t.Action("playEffect","teleportEffect,"+s[2]+","+s[3],null,null,t.curAction.followUp.followUp.followUp)}},n.setButtonState=function(i){var s=e(i);t.buttons[s[0]].setState(s[1])},n.skipDialog=function(e){t.dialoger.skipAll()},n.follow=function(t){var i=e(t),s=a(i[0]),n=a(i[1]);s.follow(n)},n.unfollow=function(t){var i=e(t),s=a(i[0]);s.unfollow()},n.addOverlay=function(i){var s=e(i),n=t.sprites[s[0]];n.x=t.Stage.x,n.y=t.Stage.y,t.curRoom.addSprite(n)},n.removeOverlay=function(i){var s=e(i),n=t.sprites[s[0]];t.curRoom.removeSprite(n)},n.save=function(i){var s=e(i),n=s.length>0&&"true"==s[0],a=s.length>1&&"true"==s[1];t.saveStateToStorage(t.char.name+", "+t.curRoom.name,n,a)},n.load=function(i){var s=e(i),n=s.length>0&&"true"==s[0],a=s.length>1&&"true"==s[1];t.loadStateFromStorage(n,a)},n.saveOrLoad=function(i){var s=e(i),n=s.length>0&&"true"==s[0],a=[];t.isStateInStorage(!1,n)&&a.push(new t.Action("load","false, "+n,"Load "+t.getStateDescription(!1))),t.isStateInStorage(!0,n)&&a.push(new t.Action("load","true, "+n,"Load "+t.getStateDescription(!0))),t.tests.storage&&a.push(new t.Action("save","false,"+n,"Save")),a.push(new t.Action("cancel",null,"Cancel")),t.chooser.choices=a,t.chooser.beginChoosing(t.Stage.x+20,t.Stage.y+50)},n.setGameState=function(i){var s=e(i);t.gameState[s[0]]=s[1]},n.goBack=function(t){var i=e(t),s=a(i[0]);s.x=s.oldX,s.y=s.oldY},n.try=function(t){for(var e=s(t),i=0;i<e.length;i++){var n=e[i];if(n.detonate=!0,n.tryToTrigger())return}},n.walk=function(t){var i=e(t),s=a(i[0]),n=i[1];"function"==typeof s["move"+n]&&s["move"+n]()},n.cancel=function(){};var a=t.parseCharacterString=function(e){return"char"==e?t.char:t.sprites[e]};return t.commands=n,t}(Sburb||{}),Sburb=function(t){function e(t){return t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}function i(e,i,s){for(var n in s)if(s.hasOwnProperty(n)){var a=s[n],o=!1;for(var r in i)if(i.hasOwnProperty(r)&&i[r].contains(a)){o=!0;break}o||(e=a.serialize(e))}for(var h in t.buttons)if(t.buttons.hasOwnProperty(h)){var l=t.buttons[h];t.hud[l.name]||(e=l.serialize(e))}return e}function s(t,e){t=t.concat("\n<rooms>\n");for(var i in e)e.hasOwnProperty(i)&&(t=e[i].serialize(t));return t=t.concat("\n</rooms>\n")}function n(t,i){t=t.concat("\n<gameState>\n");for(var s in i)i.hasOwnProperty(s)&&(t=t.concat("  <"+s+">"+e(i[s])+"</"+s+">"));return t=t.concat("\n</gameState>\n")}function a(t,e){t=t.concat("<actionQueues>");for(var i=0;i<e.length;i++)e[i].curAction&&(t=e[i].serialize(t));return t=t.concat("\n</actionQueues>\n")}function o(t,e,i){t=t.concat("\n<assets>");for(var s in e)if(e.hasOwnProperty(s)){var n=e[s],a="";if("graphic"==n.type)a+=n.originalVals;else if("audio"==n.type)for(var o=!1,r=0;r<n.originalVals.length;r++){var h=n.originalVals[r];a+=(o?";":"")+h,o=!0}else if("path"==n.type)for(var r=0;r<n.points.length;r++)a=a.concat(n.points[r].x+","+n.points[r].y),r!=n.points.length-1&&(a=a.concat(";"));else"movie"==n.type?a+=n.originalVals:"font"==n.type?a+=n.originalVals:"text"==n.type&&(a+=escape(n.text.trim()));t=t.concat("\n<asset name='"+n.name+"' type='"+n.type+"' "),t=t.concat(" >"),t=t.concat(a),t=t.concat("</asset>")}t=t.concat("\n</assets>\n"),t=t.concat("\n<effects>");for(var l in i)if(i.hasOwnProperty(l)){var u=i[l];t=u.serialize(t)}return t=t.concat("\n</effects>\n")}function r(t,e){t=t.concat("\n<classes>");try{serializer=new XMLSerializer;for(var i in e)e.hasOwnProperty(i)&&(t=t.concat(serializer.serializeToString(e[i])))}catch(s){for(var i in e)e.hasOwnProperty(i)&&(t=t.concat(e[i].xml))}return t=t.concat("\n</classes>\n")}function h(e,i,s){e=e.concat("\n<hud>");for(var n in i)i.hasOwnProperty(n)&&(e=i[n].serialize(e));e=t.dialoger.serialize(e);var a=s.dialogSpriteLeft.animations;e=e.concat("\n<dialogsprites>");for(var o in a)a.hasOwnProperty(o)&&(e=a[o].serialize(e));return e=e.concat("\n</dialogsprites>"),e=e.concat("\n</hud>\n")}function l(){t.assetManager.purge(),t.assets=t.assetManager.assets}function u(){t.rooms&&delete t.rooms,t.sprites&&delete t.sprites,t.rooms={},t.bgm&&(t.bgm.stop(),t.bgm=null);for(var e in t.Bins)t.Bins.hasOwnProperty(e)&&(t.Bins[e].innerHTML="");t.gameState={},t.globalVolume=1,t.hud={},t.sprites={},t.buttons={},t.effects={},t.curAction=null,t.actionQueues=[],t.nextQueueId=0,t.pressed={},t.pressedOrder=[],t.chooser=new t.Chooser,t.dialoger=null,t.curRoom=null,t.char=null,t.assetManager.resourcePath="",t.assetManager.levelPath="",t.loadedFiles={}}function c(e,i){t.haltUpdateProcess();var s=e,n=t.parseXML(s);i||(l(),u());var a=n.attributes,o=a.getNamedItem("levelPath");o&&(t.assetManager.levelPath="/"==o.value.charAt(o.value.length-1)?o.value:o.value+"/");var r=a.getNamedItem("resourcePath");r&&(t.assetManager.resourcePath=r.value);var h=a.getNamedItem("name");h&&(t.name=h.value);var c=a.getNamedItem("version");c&&(t.version=c.value);var d=a.getNamedItem("width");d&&t.setDimensions(d.value,null);var f=a.getNamedItem("height");f&&t.setDimensions(null,f.value);var m=a.getNamedItem("loadedFiles");if(m)for(var y=m.value.split(","),w=0;w<y.length;w++)t.loadedFiles[y[w]]=!0;q++,p(n),q--,g(n),G.push(n),v(n)}function d(t,e){this.name="XMLParsingError",this.message=f(t),this.input=e||""}function f(t){if(3==t.nodeType)return t.nodeValue;if("h3"==t.nodeName)return"";for(var e="",i=0;i<t.childNodes.length;i++)e+=f(t.childNodes[i]);return e}function p(e){var i=e.getElementsByTagName("dependencies")[0];if(i)for(var s=i.getElementsByTagName("dependency"),n=0;n<s.length;n++){var a=s[n].firstChild.nodeValue.trim();t.loadSerialFromXML(a,!0)}}function g(e){var i=e.attributes,s=i.getNamedItem("description");s?t.assetManager.description=s.value:t.assetManager.description="assets";for(var n=e.getElementsByTagName("asset"),a=0;a<n.length;a++){var o=n[a],r=o.attributes,h=r.getNamedItem("name").value;t.assetManager.isLoaded(h)||m(o)}}function m(e){var i=y(e);t.assetManager.loadAsset(i)}function y(e){var i=e.attributes,s=i.getNamedItem("name").value,n=i.getNamedItem("type").value,a=e.firstChild.nodeValue.trim(),o=i.getNamedItem("blob-urls"),r=[];o&&(r=o.value.split(";")),0===r.length&&(r=null);var h;if("graphic"==n)h=t.createGraphicAsset(s,a,r);else if("audio"==n){var l=a.split(";");h=t.createAudioAsset(s,l,r)}else if("path"==n){for(var u=a.split(";"),c=new t.Path,d=0;d<u.length;d++){var f=u[d].split(",");c.push({x:parseInt(f[0]),y:parseInt(f[1])})}h=t.createPathAsset(s,c)}else"movie"==n?h=t.createMovieAsset(s,a,r):"font"==n?h=t.createFontAsset(s,a):"text"==n&&(h=t.createTextAsset(s,a));return h._raw_xml=e,h}function v(){if(H&&(clearTimeout(H),H=null),!t.assetManager.finishedLoading())return void(H=setTimeout(function(){v()},500));for(;G.length>0;){var e=G[0];G.splice(0,1),b(e),S(e),M(e),N(e),C(e),B(e),F(e),R(e),L(e),x(e),z(e),k(e)}0==G.length&&0==q&&t.startUpdateProcess()}function w(e){var i=e.getElementsByTagName("hud");if(i.length>0){var s=i[0].getElementsByTagName("dialogsprites");s.length>0&&O(s[0],t.assets)}}function x(e){var i=e.getElementsByTagName("effects");i.length>0&&E(i[0],t.assets,t.effects)}function b(t){var e=t.getElementsByTagName("classes");if(e.length>0){for(var i=e[0].childNodes,s=0;s<i.length;s++){var n=i[s];if("#text"!=n.nodeName&&"#comment"!=n.nodeName){S(n);var a=n.attributes;_[a.getNamedItem("class").value]=n.cloneNode(!0)}}t.removeChild(t.getElementsByTagName("classes")[0])}}function S(t){for(var e in _)if(_.hasOwnProperty(e))for(var i=_[e],s=t.getElementsByTagName(i.nodeName),n=0;n<s.length;n++){var a=s[n];A(i,a)}}function A(t,e){var i=t.attributes.getNamedItem("class").value,s=e.attributes.getNamedItem("class");s&&s.value==i&&I(t,e)}function I(t,e){for(var i=t.attributes,s=t.childNodes,n=e.attributes,a=(e.childNodes,0);a<i.length;a++){var o=i[a];n.getNamedItem(o.name)||e.setAttribute(o.name,o.value)}for(var a=0;a<s.length;a++)e.appendChild(s[a].cloneNode(!0))}function M(e){for(var i=e.getElementsByTagName("spritebutton"),s=0;s<i.length;s++){var n=i[s],a=t.parseSpriteButton(n);t.buttons[a.name]=a}}function N(e){for(var i=e.getElementsByTagName("sprite"),s=0;s<i.length;s++){var n=i[s],a=t.parseSprite(n,t.assets);t.sprites[a.name]=a,T(n,a)}}function T(e,i){for(var s=e.childNodes,n=0;n<s.length;n++)if("#text"!=s[n].nodeName&&"action"==s[n].nodeName){var a=t.parseAction(s[n]);i.addAction(a)}}function C(e){for(var i=e.getElementsByTagName("character"),s=0;s<i.length;s++){var n=i[s],a=t.parseCharacter(n,t.assets);t.sprites[a.name]=a,T(n,a)}}function B(e){for(var i=e.getElementsByTagName("fighter"),s=0;s<i.length;s++){var n=i[s],a=t.parseFighter(n,t.assets);t.sprites[a.name]=a,T(n,a)}}function F(e){for(var i=e.getElementsByTagName("room"),s=0;s<i.length;s++){var n=i[s],a=t.parseRoom(n,t.assets,t.sprites);t.rooms[a.name]=a}}function R(e){for(var i=e.getElementsByTagName("gameState"),s=0;s<i.length;s++)for(var n=i[s],a=n.childNodes,o=0;o<a.length;o++){var r=a[o];if(3!==r.nodeType){var h=r.tagName,l=r.firstChild.nodeValue;t.gameState[h]=l}}}function k(e){var i=e.getElementsByTagName("actionQueues");if(0!=i.length)for(var s=i[0].childNodes,n=0;n<s.length;n++)if("#text"!=s[n].nodeName){var a=t.parseActionQueue(s[n]);t.actionQueues.push(a)}}function z(e){var i=e.attributes,s=i.getNamedItem("char");s&&(t.focus=t.char=t.sprites[s.value],t.char.becomePlayer());var n=i.getNamedItem("mode");n&&(t.engineMode=n.value);var a=i.getNamedItem("scale");a&&(t.Stage.scaleX=t.Stage.scaleY=parseInt(a.value));var o=i.getNamedItem("nextQueueId");o&&(t.nextQueueId=parseInt(o.value));var r=i.getNamedItem("curRoom");if(r)t.curRoom=t.rooms[r.value],t.curRoom.enter();else if(null==t.curRoom&&null!=t.char)for(var h in t.rooms)if(t.rooms.hasOwnProperty(h)){var l=t.rooms[h];if(l.contains(t.char)){t.curRoom=l,t.curRoom.enter();break}}var u=i.getNamedItem("bgm");if(u){var c=u.value.split(",");t.changeBGM(new t.BGM(t.assets[c[0]],parseFloat(c.length>1?c[1]:"0")))}var d,f;if(i.getNamedItem("startAction")){f=i.getNamedItem("startAction").value;for(var p=0;p<e.childNodes.length;p++){var g=e.childNodes[p];"action"!=g.tagName||g.attributes.getNamedItem("name").value!=f||(d=t.parseAction(g))}d&&t.performAction(d)}}function L(e){var i=e.getElementsByTagName("hud");if(i.length>0)for(var s=i[0].childNodes,n=0;n<s.length;n++){var a=s[n];if("spritebutton"==a.nodeName){var o=a.attributes.getNamedItem("name").value;t.hud[o]=t.buttons[o]}}P(e),w(e)}function P(e){var i=e.getElementsByTagName("dialoger");if(i.length>0){var s=null,n=null;t.dialoger&&(s=t.dialoger.dialogSpriteLeft,n=t.dialoger.dialogSpriteRight),t.dialoger=t.parseDialoger(i[0]),t.dialoger.dialogSpriteLeft=s,t.dialoger.dialogSpriteRight=n}}function O(e,i){t.dialoger||(t.dialoger={}),t.dialoger.dialogSpriteLeft||(t.dialoger.dialogSpriteLeft=new t.Sprite("dialogSprite",-1e3,t.Stage.height,0,0),t.dialoger.dialogSpriteRight=new t.Sprite("dialogSprite",t.Stage.width+1e3,t.Stage.height,0,0));for(var s=e.getElementsByTagName("animation"),n=0;n<s.length;n++)t.dialoger.dialogSpriteLeft.addAnimation(t.parseAnimation(s[n],i)),t.dialoger.dialogSpriteRight.addAnimation(t.parseAnimation(s[n],i))}function E(e,i,s){for(var n=e.getElementsByTagName("animation"),a=0;a<n.length;a++){var o=t.parseAnimation(n[a],i);s[o.name]=o}}function D(t,e,i){for(var s=0;s<e.length;s++){var n=e[s],a=i[n.attributes.getNamedItem("name").value];t.addSprite(a)}}function U(t,e,i){for(var s=e[0].getElementsByTagName("walkable"),n=0;n<s.length;n++){var a=s[n],o=a.attributes;t.addWalkable(i[o.getNamedItem("path").value])}for(var r=e[0].getElementsByTagName("unwalkable"),n=0;n<r.length;n++){var a=r[n],o=a.attributes;t.addUnwalkable(i[o.getNamedItem("path").value])}for(var h=e[0].getElementsByTagName("motionpath"),n=0;n<h.length;n++){var a=h[n],o=a.attributes;t.addMotionPath(i[o.getNamedItem("path").value],o.getNamedItem("xtox")?parseFloat(o.getNamedItem("xtox").value):1,o.getNamedItem("xtoy")?parseFloat(o.getNamedItem("xtoy").value):0,o.getNamedItem("ytox")?parseFloat(o.getNamedItem("ytox").value):0,o.getNamedItem("ytoy")?parseFloat(o.getNamedItem("ytoy").value):1,o.getNamedItem("dx")?parseFloat(o.getNamedItem("dx").value):0,o.getNamedItem("dy")?parseFloat(o.getNamedItem("dy").value):0)}}function Q(e,i){for(var s=i[0].childNodes,n=0;n<s.length;n++)"trigger"==s[n].nodeName&&e.addTrigger(t.parseTrigger(s[n]))}t.loadedFiles={};var _={},q=0,G=[],H=null;return t.serialize=function(e){var l=e.assets,u=e.effects,c=e.rooms,d=e.sprites,f=e.hud,p=e.dialoger,g=(e.curRoom,e.gameState),m=e.actionQueues,y=e.char,v="",w=!1;for(var x in t.loadedFiles)t.loadedFiles.hasOwnProperty(x)&&(v=v+(w?",":"")+x,w=!0);var b=document.getElementById("serialText"),S="<sburb char='"+y.name+(t.bgm?"' bgm='"+t.bgm.asset.name+(t.bgm.startLoop?","+t.bgm.startLoop:""):"")+(1!=t.Stage.scaleX?"' scale='"+t.Stage.scaleX:"")+(t.nextQueueId>0?"' nextQueueId='"+t.nextQueueId:"")+(t.assetManager.resourcePath?"' resourcePath='"+t.assetManager.resourcePath:"")+(t.assetManager.levelPath?"' levelPath='"+t.assetManager.levelPath:"")+(w?"' loadedFiles='"+v:"")+"'>\n";return S=o(S,l,u),S=r(S,_),S=h(S,f,p),S=i(S,c,d),S=s(S,c),S=n(S,g),S=a(S,m),S=S.concat("\n</sburb>"),b&&(b.value=S),S},t.saveStateToStorage=function(e,i,s){e="undefined"!=typeof e?e:"SaveFile",i="undefined"!=typeof i&&i,s="undefined"!=typeof s&&s;var n;if(!t.tests.storage)return!1;if(t.tests.storage.local&&t.tests.storage.session)n=s?localStorage:sessionStorage;else if(t.tests.storage.local)n=localStorage;else{if(!t.tests.storage.session)return!1;n=sessionStorage}var a=t.serialize(t);compressed=Iuppiter.Base64.encode(Iuppiter.compress(a),!0);var o=e+(i?" (auto)":"")+"_savedState_"+t.name+":"+t.version;return t.deleteStateFromStorage(i),n.setItem(o,compressed),!0},t.loadStateFromStorage=function(e,i){description="undefined"!=typeof description?description:"SaveFile",e="undefined"!=typeof e&&e,i="undefined"!=typeof i&&i;var s;if(!t.tests.storage)return!1;if(t.tests.storage.local&&t.tests.storage.session)s=i?localStorage:sessionStorage;else if(t.tests.storage.local)s=localStorage;else{if(!t.tests.storage.session)return!1;s=sessionStorage}var n="";for(var a in s)if(s.hasOwnProperty(a)){var o=a.indexOf("_savedState_");if(o>=0){if(e&&a.indexOf("(auto)")>=0&&a.indexOf(t.name+":"+t.version)>=o){n=a;break}if(!e&&a.indexOf("(auto)")<0&&a.indexOf(t.name+":"+t.version)>=o){n=a;break}}}var r=s.getItem(n);if(!r)return!1;var h=Iuppiter.decompress(Iuppiter.Base64.decode(Iuppiter.toByteArray(r),!0)).replace(/\0/g,"");return t.loadSerial(h),!0},t.getStateDescription=function(e,i){e="undefined"!=typeof e&&e,i="undefined"!=typeof i&&i;var s;if(!t.tests.storage)return null;if(t.tests.storage.local&&t.tests.storage.session)s=i?localStorage:sessionStorage;else if(t.tests.storage.local)s=localStorage;else{if(!t.tests.storage.session)return null;s=sessionStorage}for(var n in s)if(s.hasOwnProperty(n)){var a=n.indexOf("_savedState_");if(a>=0){if(e&&n.indexOf("(auto)")>=0&&n.indexOf(t.name+":"+t.version)>=a)return n.substring(0,a);if(!e&&n.indexOf("(auto)")<0&&n.indexOf(t.name+":"+t.version)>=a)return n.substring(0,a)}}return null},t.deleteStateFromStorage=function(e,i){e="undefined"!=typeof e&&e,i="undefined"!=typeof i&&i;var s;if(t.tests.storage){if(t.tests.storage.local&&t.tests.storage.session)s=i?localStorage:sessionStorage;else if(t.tests.storage.local)s=localStorage;else{if(!t.tests.storage.session)return;s=sessionStorage}t.deleteOldVersionStates(i);for(var n in s)if(s.hasOwnProperty(n)){var a=n.indexOf("_savedState_");a>=0&&(e&&n.indexOf("(auto)")>=0&&n.indexOf(t.name+":"+t.version)>=a?s.removeItem(n):!e&&n.indexOf("(auto)")<0&&n.indexOf(t.name+":"+t.version)>=a&&s.removeItem(n))}}},t.deleteOldVersionStates=function(e){e="undefined"!=typeof e&&e;var i;if(t.tests.storage){if(t.tests.storage.local&&t.tests.storage.session)i=e?localStorage:sessionStorage;else if(t.tests.storage.local)i=localStorage;else{if(!t.tests.storage.session)return;i=sessionStorage}for(var s in i)if(i.hasOwnProperty(s)){var n=s.indexOf("_savedState_");n>=0&&s.indexOf(t.name+":")>=n&&s.indexOf(":"+t.version)<0&&i.removeItem(s)}}},t.isStateInStorage=function(e,i){e="undefined"!=typeof e&&e,i="undefined"!=typeof i&&i;var s;if(!t.tests.storage)return!1;if(t.tests.storage.local&&t.tests.storage.session)s=i?localStorage:sessionStorage;else if(t.tests.storage.local)s=localStorage;else{if(!t.tests.storage.session)return!1;s=sessionStorage}for(var n in s)if(s.hasOwnProperty(n)){var a=n.indexOf("_savedState_");if(a>=0){if(e&&n.indexOf("(auto)")>=0&&n.indexOf(t.name+":"+t.version)>=a)return!0;if(!e&&n.indexOf("(auto)")<0&&n.indexOf(t.name+":"+t.version)>=a)return!0}}return!1},t.loadSerialFromXML=function(e,i){if(t.haltUpdateProcess(),e=t.assetManager.levelPath+e,i&&t.loadedFiles[e])return void t.startUpdateProcess();t.loadedFiles[e]=!0;var s=new XMLHttpRequest;s.open("GET",e,!1);try{s.send(null)}catch(t){return console.log("Could not load level descriptors."),void(fi=document.getElementById("levelFile"))}if(200===s.status||0==s.status)try{c(s.responseText,i)}catch(t){throw t instanceof d&&(t.file?console.error("Loaded from '"+e+"'"):(t.file=e,console.error("Error in '"+e+"'"))),t}},t.parseXML=function(t){var e=new DOMParser,i=e.parseFromString(t,"text/xml");if(i.getElementsByTagName("parsererror").length>0){var s=i.getElementsByTagName("parsererror")[0];throw new d(s,t)}return i.documentElement},d.prototype=new Error,t.serializeAttribute=function(t,e){return t[e]?" "+e+"='"+t[e]+"' ":""},t.serializeAttributes=function(e){str="";for(var i=1;i<arguments.length;i++)str=str.concat(t.serializeAttribute(e,arguments[i]));return str},t.serialLoadRoomSprites=D,t.serialLoadRoomPaths=U,t.serialLoadRoomTriggers=Q,t.loadSerial=c,t}(Sburb||{}),Sburb=function(t){function e(t){str="";for(var e=1;e<arguments.length;e++)str=str.concat(i(t,arguments[e]));return str}function i(t,e){var i=t[e],s=" "+e+"='";return s+=i.hasOwnProperty("x")?i.x+",":"",s+=i.hasOwnProperty("y")?i.y+",":"",s+=i.hasOwnProperty("width")?i.width+",":"",s+=i.hasOwnProperty("height")?i.height+",":"",s=s.substring(0,s.length-1),s+="' "}function s(t){var e=t.split(","),i={};switch(e.length){case 4:i.height=parseInt(e[3]);case 3:i.width=parseInt(e[2]);case 2:i.y=parseInt(e[1]);case 1:i.x=parseInt(e[0])}return i}return t.Dialoger=function(e,i,s,n,a,o,r,h,l,u,c,d){this.name="default",this.currentDialog=null,this.talking=!1,this.queue=[],this.extraArgs=null,this.dialog=new t.FontEngine,this.hiddenPos=e,this.alertPos=i,this.talkPosLeft=s,this.talkPosRight=n,this.spriteStartRight=a,this.spriteEndRight=o,this.spriteStartLeft=r,this.spriteEndLeft=h,this.alertTextDimensions=l,this.leftTextDimensions=u,this.rightTextDimensions=c,this.pos={x:e.x,y:e.y},this.actor=null,this.dialogSide="Left",this.graphic=null,this.box=null,this.defaultBox=null,this.type=d,this.handleType(),this.inPosition=!1},t.Dialoger.prototype.dialogSpriteLeft=null,t.Dialoger.prototype.dialogSpriteRight=null,t.Dialoger.prototype.handleType=function(){"social"==this.type&&(this.hashes=new t.FontEngine,this.hashes.setFormatted(!1),this.choices={})},t.Dialoger.prototype.nudge=function(){this.inPosition&&(this.dialog.isShowingAll()?this.dialog.nextBatch()?this.dialog.showSubText(0,1):this.queue.length>0?this.nextDialog():this.talking=!1:this.dialog.showAll())},t.Dialoger.prototype.skipAll=function(){this.talking=!1},t.Dialoger.prototype.startDialog=function(e){this.inPosition=!1,this.actor=null,this.currentDialog=e,this.queue=e.split("@");for(var i=this.queue.length-2;i>=0;i--){
for(var s=this.queue[i],n=0,a=s.length-1;a>=0&&"/"==s.charAt(a);)n++,a--;n%2==1&&(this.queue[i]+="@"+this.queue[i+1],this.queue.splice(i+1,1))}"social"==this.type&&this.hashes.setText(""),this.queue.reverse(),this.queue.pop(),this.nextDialog(),"social"==this.type&&(t.buttons.spadeButton.startAnimation("state0"),t.buttons.heartButton.startAnimation("state0"),this.actor&&!this.choices[this.currentDialog]?this.choices[this.currentDialog]=0:1==this.choices[this.currentDialog]?t.buttons.heartButton.startAnimation("state1"):t.buttons.spadeButton.startAnimation("state1")),this.box.x=-this.box.width,this.talking=!0},t.Dialoger.prototype.nextDialog=function(){var e=this.queue.pop().trim();this.dialog.setText(e),this.dialog.showSubText(0,0);var i=e.split(" ",1)[0];if(i.indexOf("~")>=0){var s=i.indexOf("~"),n=i.length,a=i.indexOf("%");a>s&&(n=a);var o=i.indexOf(":");o>=0&&o<n&&(n=o);var r=i.substring(s+1,n);if(i=i.substring(0,s)+i.substring(n,i.length),this.graphic=t.sprites[r],!this.graphic){var h=t.assets[r];this.graphic=new t.Sprite,this.graphic.addAnimation(new t.Animation("image",h,0,0,h.width,h.height,0,1,1)),this.graphic.startAnimation("image")}}else this.graphic=null;if(i.indexOf("%")>=0){var s=i.indexOf("%"),n=i.length,o=i.indexOf(":");o>=0&&o<n&&(n=o);var r=i.substring(s+1,n);i=i.substring(0,s)+i.substring(n,i.length),this.setBox(r)}else this.box=this.defaultBox;if(i.indexOf(":")>=0){var s=i.indexOf(":"),n=i.length,r=i.substring(s+1,n);i=i.substring(0,s)+i.substring(n,i.length),this.extraArgs=r,"social"==this.type&&this.hashes.setText(this.extraArgs.replace(/#/g," #").replace(/-/g," ").trim())}else this.extraArgs=null,"social"==this.type&&this.hashes.setText("");if("!"==i)this.actor=null,this.dialogSide="Left";else{var l;if(l=i.indexOf("_")>=0?i.substring(0,i.indexOf("_")):i.substring(0,2),null==this.actor){this.dialogSide="Left";var u=this.dialogOnSide(this.dialogSide),c=this.startOnSide(this.oppositeSide(this.dialogSide));u.x=c.x,u.y=c.y}else if(0!=this.actor.indexOf(l)&&0!=l.indexOf(this.actor)){this.dialogSide=this.oppositeSide(this.dialogSide);var u=this.dialogOnSide(this.dialogSide),c=this.startOnSide(this.dialogSide);u.x=c.x,u.y=c.y}this.actor=l,this.dialogOnSide(this.dialogSide).startAnimation(i)}},t.Dialoger.prototype.oppositeSide=function(t){return"Left"==t?"Right":"Left"},t.Dialoger.prototype.dialogOnSide=function(t){return this["dialogSprite"+t]},t.Dialoger.prototype.startOnSide=function(t){return this["spriteStart"+t]},t.Dialoger.prototype.endOnSide=function(t){return this["spriteEnd"+t]},t.Dialoger.prototype.moveToward=function(t,e,i){return"number"!=typeof i&&(i=100),Math.abs(t.x-e.x)>i?t.x+=i*Math.abs(e.x-t.x)/(e.x-t.x):t.x=e.x,Math.abs(t.y-e.y)>i?t.y+=i*Math.abs(e.y-t.y)/(e.y-t.y):t.y=e.y,t.y==e.y&&t.x==e.x},t.Dialoger.prototype.update=function(){if("social"==this.type)var e=t.buttons.closeButton,i=t.buttons.spadeButton,s=t.buttons.heartButton,n=t.buttons.bubbleButton,a=t.sprites.hashTagBar;if(this.talking){var o,r=!0;null==this.actor?(o=this.alertPos,this.inPosition=!0):(o=this["talkPos"+this.dialogSide],r=this.moveToward(this.dialogOnSide(this.dialogSide),this.endOnSide(this.dialogSide)),this.moveToward(this.dialogOnSide(this.oppositeSide(this.dialogSide)),this.startOnSide(this.oppositeSide(this.dialogSide))));var h=!1;if(this.moveToward(this.pos,o,110)&&r){if(this.dialog.start==this.dialog.end){this.inPosition=!0;var l=this.decideDialogDimensions();this.dialog.setDimensions(l.x,l.y,l.width,l.height),h=!0}this.dialog.showSubText(null,this.dialog.end+2),this.actor&&this.dialogOnSide(this.dialogSide).update(),"social"==this.type&&(0==this.queue.length?null!=this.actor&&(i.update(),s.update(),n.update()):e.update(),a.update())}else this.inPosition=!1;this.graphic&&(this.graphic.x=this.pos.x,this.graphic.y=this.pos.y,this.graphic.update())}else if(this.graphic=null,this.moveToward(this.pos,this.hiddenPos,120),null!=this.actor&&this.moveToward(this.dialogOnSide(this.dialogSide),this.startOnSide(this.oppositeSide(this.dialogSide)))){var u=this.startOnSide(this.dialogSide),c=this.dialogOnSide(this.dialogSide);c.x=u.x,c.y=u.y;var d=this.startOnSide(this.oppositeSide(this.dialogSide)),f=this.dialogOnSide(this.oppositeSide(this.dialogSide));f.x=d.x,f.y=d.y,this.actor=null}this.box.x=this.pos.x,this.box.y=this.pos.y,"social"==this.type&&(a.x=this.pos.x,a.y=this.pos.y+this.box.height,"Right"==this.dialogSide?(i.x=a.x+20,s.x=a.x+60,n.x=a.x+100):(i.x=a.x+a.animation.colSize-120,s.x=a.x+a.animation.colSize-80,n.x=a.x+a.animation.colSize-40),i.y=a.y+15,s.y=a.y+15,n.y=a.y+15,this.actor&&("state1"==t.buttons.spadeButton.animation.name?this.choices[this.currentDialog]=-1:"state1"==t.buttons.heartButton.animation.name?this.choices[this.currentDialog]=1:this.choices[this.currentDialog]=0),h&&("Right"==this.dialogSide?this.hashes.setDimensions(this.dialog.x,a.y+13,this.dialog.width,a.animation.rowSize-10):this.hashes.setDimensions(this.dialog.x,a.y+13,this.dialog.width,a.animation.rowSize-10)),this.dialog.isShowingAll()&&this.dialog.onLastBatch()?this.hashes.showAll():this.hashes.showSubText(0,0)),this.box.update()},t.Dialoger.prototype.decideDialogDimensions=function(){return null==this.actor?{x:this.pos.x+this.alertTextDimensions.x,y:this.pos.y+this.alertTextDimensions.y,width:this.alertTextDimensions.width,height:this.alertTextDimensions.height}:"Left"==this.dialogSide?{x:this.pos.x+this.leftTextDimensions.x,y:this.pos.y+this.leftTextDimensions.y,width:this.leftTextDimensions.width,height:this.leftTextDimensions.height}:{x:this.pos.x+this.rightTextDimensions.x,y:this.pos.y+this.rightTextDimensions.y,width:this.rightTextDimensions.width,height:this.rightTextDimensions.height}},t.Dialoger.prototype.setBox=function(e){var i=t.sprites[e];if(!i){var s=t.assets[e];i=new t.Sprite("dialogBox",t.Stage.width+1,1e3,s.width,s.height,null,null,0),i.addAnimation(new t.Animation("image",s,0,0,s.width,s.height,0,1,1)),i.startAnimation("image")}this.box?(i.x=this.box.x,i.y=this.box.y):this.defaultBox=i,this.box=i},t.Dialoger.prototype.draw=function(){"social"==this.type&&t.sprites.hashTagBar.draw(),this.box.draw(),this.graphic&&this.graphic.draw(),this.talking&&(this.dialog.draw(),"social"==this.type&&(this.queue.length>0&&t.buttons.closeButton.draw(),this.dialog.start!=this.dialog.end&&(this.hashes.draw(),0==this.queue.length&&null!=this.actor&&(t.buttons.spadeButton.draw(),t.buttons.heartButton.draw(),t.buttons.bubbleButton.draw())))),null!=this.actor&&(this.dialogSpriteLeft.draw(),this.dialogSpriteRight.animation&&(this.dialogSpriteRight.animation.flipX=!0),this.dialogSpriteRight.draw())},t.parseDialoger=function(e){var i=e.attributes,n=s(i.getNamedItem("hiddenPos").value),a=s(i.getNamedItem("alertPos").value),o=s(i.getNamedItem("talkPosLeft").value),r=s(i.getNamedItem("talkPosRight").value),h=s(i.getNamedItem("spriteStartRight").value),l=s(i.getNamedItem("spriteEndRight").value),u=s(i.getNamedItem("spriteStartLeft").value),c=s(i.getNamedItem("spriteEndLeft").value),d=s(i.getNamedItem("alertTextDimensions").value),f=s(i.getNamedItem("leftTextDimensions").value),p=s(i.getNamedItem("rightTextDimensions").value),g=i.getNamedItem("type")?i.getNamedItem("type").value:"standard",m=new t.Dialoger(n,a,o,r,h,l,u,c,d,f,p,g),y=i.getNamedItem("box").value;return m.setBox(y),m},t.Dialoger.prototype.serialize=function(i){return i+="\n<dialoger "+e(this,"hiddenPos","alertPos","talkPosLeft","talkPosRight","spriteStartRight","spriteEndRight","spriteStartLeft","spriteEndLeft","alertTextDimensions","leftTextDimensions","rightTextDimensions"),i+=t.serializeAttribute(this,"type"),i+="box='"+this.box.animation.sheet.name+"' ",i+=">",i+="</dialoger>"},t}(Sburb||{}),Sburb=function(t){return t.Chooser=function(){this.choosing=!1,this.choices=[],this.choice=0,this.dialogs=[],this.time=0},t.Chooser.prototype.minWidth=160,t.Chooser.prototype.nextChoice=function(){this.choice=(this.choice+1)%this.choices.length},t.Chooser.prototype.prevChoice=function(){this.choice=(this.choice-1+this.choices.length)%this.choices.length},t.Chooser.prototype.beginChoosing=function(e,i){var s=this.minWidth,n=0,a=new t.FontEngine;for(o=0;o<this.choices.length;o++)s=Math.max(s,(this.choices[o].name.length+3)*a.charWidth+10);n=a.lineHeight*this.choices.length+10,e<t.Stage.x+10&&(e=t.Stage.x+10),i<t.Stage.y+10&&(i=t.Stage.y+10),e+s>t.Stage.x+t.Stage.width-10&&(e=t.Stage.x+t.Stage.width-s-10),i+n>t.Stage.y+t.Stage.height-10&&(i=t.Stage.y+t.Stage.height-n-10),this.choosing=!0,this.choice=0,this.dialogs=[];for(var o=0;o<this.choices.length;o++){var r=new t.FontEngine(" > "+this.choices[o].name);r.showSubText(0,1),r.setDimensions(e,i+o*r.lineHeight),this.dialogs.push(r)}},t.Chooser.prototype.draw=function(){if(this.choosing){t.stage.save();var e,i,s,n=this.minWidth,a=0;for(e=this.dialogs[0].x,i=this.dialogs[0].y-1,s=0;s<this.dialogs.length;s++)n=Math.max(n,this.dialogs[s].lines[0].length*this.dialogs[s].charWidth+10);for(a=this.dialogs[0].lineHeight*this.dialogs.length,t.stage.fillStyle="#ff9900",t.stage.fillRect(e-6,i-6,n+12,a+13),t.stage.fillStyle="#ffff00",t.stage.fillRect(e-2,i-2,n+4,a+5),t.stage.fillStyle="#000000",t.stage.fillRect(e,i,n,a),s=0;s<this.dialogs.length;s++)this.dialogs[s].draw();t.stage.restore()}},t.Chooser.prototype.update=function(){if(this.choosing){this.time++;for(var e=0;e<this.dialogs.length;e++){var i=this.dialogs[e];i.showSubText(null,i.end+1),e==this.choice?(this.time%t.Stage.fps<t.Stage.fps/2?i.start=2:i.start=0,i.color="#cccccc"):(i.start=0,i.color="#ffffff")}}},t}(Sburb||{}),Sburb=function(t){return t.globalVolume=1,t.Sound=function(t){if(t){this.asset=t;var e=this;window.addEventListener("beforeunload",function(){e.pause()})}},t.Sound.prototype.play=function(t){if(window.chrome){if(this.playedOnce?this.asset.load():this.playedOnce=!0,t){var e=this;this.asset.addEventListener("playing",function(){e.asset.currentTime=t,e.asset.pause(),e.asset.removeEventListener("playing",arguments.callee),e.asset.play()},!1)}}else t&&(this.asset.currentTime=t);this.fixVolume(),this.asset.play()},t.Sound.prototype.pause=function(){this.asset.pause()},t.Sound.prototype.stop=function(){this.pause(),this.asset.currentTime=0},t.Sound.prototype.ended=function(){return this.asset.ended},t.Sound.prototype.fixVolume=function(){this.asset.volume=t.globalVolume},t.BGM=function(e,i,s){t.Sound.call(this,e),this.startLoop=0,this.endLoop=0,this.setLoopPoints(i?i:0)},t.BGM.prototype=new t.Sound,t.BGM.prototype.setLoopPoints=function(t,e){tmpAsset=this.asset,tmpAsset.addEventListener("ended",function(){tmpAsset.currentTime=t,tmpAsset.play()},!1),this.startLoop=t,this.endLoop=e},t.BGM.prototype.loop=function(){this.play(this.startLoop)},t}(Sburb||{}),Sburb=function(t){return t.AssetManager=function(){this.loopID=!1,this.space=!1,this.refresh=!1,this.totalAssets=0,this.totalLoaded=0,this.totalMeta=0,this.totalSize=0,this.loadedSize=0,this.assets={},this.loaded={},this.recurrences={},this.error=[],this.failed=[],this.maxAjax=10,this.ajaxRunning=0,this.ajaxCache=[],this.cache={},this.blobs={},this.description="",this.resourcePath="",this.levelPath="",this.mimes={jpg:"image/jpeg",gif:"image/gif",png:"image/png",svg:"image/svg+xml",mp3:"audio/mpeg",oga:"audio/ogg",ogg:"audio/ogg",ttf:"application/x-font-ttf",woff:"application/x-font-woff",swf:"application/x-shockwave-flash",flv:"application/x-shockwave-flash"}},t.AssetManager.prototype.start=function(){this.stop(),this.loopID=setInterval(function(){t.assetManager.loop()},33)},t.AssetManager.prototype.stop=function(){this.loopID&&(clearInterval(this.loopID),this.loopID=!1)},t.AssetManager.prototype.loop=function(){t.pressed[t.Keys.space]&&!this.space?(this.space=!0,this.refresh=!0):this.refresh=!1,t.pressed[t.Keys.space]||(this.space=!1),t.debugger.handleInputs(t.pressed),this.draw(),t.debugger.draw()},t.AssetManager.prototype.resolvePath=function(e){return e.indexOf(this.resourcePath)==-1?this.resourcePath+"/"+e+"?"+t.version:e+"?"+t.version},t.AssetManager.prototype.totalAssetsRemaining=function(){return this.totalAssets-this.totalLoaded},t.AssetManager.prototype.finishedLoading=function(){return this.totalAssets&&this.totalAssets==this.totalLoaded},t.AssetManager.prototype.draw=function(){if(t.stage.fillStyle="rgb(0,0,0)",t.stage.fillRect(-3,-3,t.Stage.width+6,t.Stage.height+6),this.loaded.preloaderBG){var e=t.assets.preloaderBG;t.stage.drawImage(e,0,0,e.width,e.height,0,0,e.width,e.height)}t.stage.fillStyle="rgb(255,255,255)",t.stage.font="10px Verdana",t.stage.textAlign="center";var i=0;if(i=this.totalSize&&this.totalMeta>=this.totalAssets?Math.floor(this.loadedSize/this.totalSize*100):Math.floor(this.totalLoaded/this.totalAssets*100),t.stage.fillText(i+"%",t.Stage.width/2,t.Stage.height-50),0==t.tests.loading&&t.stage.fillText("Warning: File loading is unreliable. Use a newer browser, like Chrome.",t.Stage.width/2,t.Stage.height-35),this.error.length){t.stage.textAlign="left";for(var s=0;s<this.error.length;s++)t.stage.fillText("Error: "+this.error[s],10,20+15*s);if(t.stage.textAlign="center",this.failed.length)if(this.refresh){this.error=["Refreshing..."];for(var s=0;s<this.failed.length;s++)this.assets[this.failed[s]].reload();this.failed=[]}else t.stage.font="18px Verdana",t.stage.fillText("Press SPACE to reload failed assets",t.Stage.width/2,t.Stage.height-70)}},t.AssetManager.prototype.isLoaded=function(t){return!!this.loaded[t]},t.AssetManager.prototype.purge=function(){for(var t in this.recurrences)this.recurrences.hasOwnProperty(t)&&clearTimeout(this.recurrences[t]);this.totalLoaded=0,this.totalAssets=0,this.totalMeta=0,this.totalSize=0,this.loadedSize=0,this.assets={},this.loaded={},this.recurrences={},this.error=[],this.failed=[]},t.AssetManager.prototype.loadAsset=function(t){var e=t.name;if(this.assets[e]=t,t.instant)return void(this.loaded[e]=!0);var i=this;this.assetAdded(e);var s=this.assets[e].assetOnLoadFunction(function(){i.assetLoaded(e)});s||this.assets[e].assetOnFailFunction(function(){i.assetFailed(e)})},t.AssetManager.prototype.assetAdded=function(t){this.totalAssets++,this.loaded[t]=!1},t.AssetManager.prototype.assetLoaded=function(e){this.assets[e]&&(this.loaded[e]||(this.loaded[e]=!0,this.totalLoaded++,this.finishedLoading()&&t._hardcode_load&&(t.finishInit(),initFinished=!0)))},t.AssetManager.prototype.assetFailed=function(t){var e=t+" failed to load";console.log(e),this.error.push(e),this.failed.push(t)},t.base64ArrayBuffer=function(e){for(var i,s,n,a,o,r="",h="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",l=new(window[t.prefixed("Uint8Array",window,!1)])(e),u=l.byteLength,c=u%3,d=u-c,f=0;f<d;f+=3)o=l[f]<<16|l[f+1]<<8|l[f+2],i=(16515072&o)>>18,s=(258048&o)>>12,n=(4032&o)>>6,a=63&o,r+=h[i]+h[s]+h[n]+h[a];return 1==c?(o=l[d],i=(252&o)>>2,s=(3&o)<<4,r+=h[i]+h[s]+"=="):2==c&&(o=l[d]<<8|l[d+1],i=(64512&o)>>10,s=(1008&o)>>4,n=(15&o)<<2,r+=h[i]+h[s]+h[n]+"="),r},t.loadGenericAsset=function(e,i,s){var n=t.assetManager.resolvePath(i),a=i.substring(i.indexOf(".")+1,i.length),o=t.assetManager.mimes[a];if(n in t.assetManager.blobs){var r=window[t.prefixed("URL",window,!1)],h=t.assetManager.blobs[n],l=!1;return l=t.tests.blobrevoke?r.createObjectURL(h,{autoRevoke:!1}):r.createObjectURL(h),void setTimeout(function(){e.success(l,s)},0)}if(n in t.assetManager.cache){var l=t.assetManager.cache[n];return void setTimeout(function(){e.success(l,s)},0)}if(t.assetManager.ajaxRunning>=t.assetManager.maxAjax)return void t.assetManager.ajaxCache.push([e,i,s]);t.assetManager.ajaxRunning+=1;var u=function(){t.assetManager.ajaxRunning-=1,t.assetManager.ajaxCache.length&&(args=t.assetManager.ajaxCache.shift(),t.loadGenericAsset(args[0],args[1],args[2]))};if([4,5,6,7,8,9,10,11].contains(t.tests.loading)){var c=new XMLHttpRequest;c.total=0,c.loaded=0,c.open("GET",n,!0),[8,9,10,11].contains(t.tests.loading)?c.responseType="blob":c.responseType="arraybuffer",c.onprogress=function(e){if(e.lengthComputable){c.total||(t.assetManager.totalMeta++,t.assetManager.totalSize+=e.total,c.total=e.total);var s=e.loaded-c.loaded;c.loaded=e.loaded,t.assetManager.loadedSize+=s}else console.log("ERROR: Length not computable for "+i)},c.onload=function(){if(200!=this.status&&0!=this.status||!this.response)e.failure(s),u();else{var i=c.total-c.loaded;c.loaded=c.total,t.assetManager.loadedSize+=i;var a=!1;if([5,6,7,9,10,11].contains(t.tests.loading)){var r=window[t.prefixed("URL",window,!1)],h=!1;if(11==t.tests.loading)h=new Blob([this.response],{type:o});else if([5,10].contains(t.tests.loading)){var l=new(window[t.prefixed("BlobBuilder",window,!1)]);l.append(this.response),h=l.getBlob(o)}else if(9==t.tests.loading)h=this.response[t.prefixed("slice",Blob.prototype,!1)](0,this.response.size,o);else if(7==t.tests.loading){var d=new Uint8Array(this.response);h=new Blob([d],{type:o})}else 6==t.tests.loading&&(h=new Blob([this.response],{type:o}));if(!h)return e.failure(s),void u();a=t.tests.blobrevoke?r.createObjectURL(h,{autoRevoke:!1}):r.createObjectURL(h),t.assetManager.blobs[n]=h}else{if(8==t.tests.loading){var f=new FileReader;return f.onload=function(i){var a=i.target.result;return a?(t.assetManager.cache[n]=a,e.success(a,s),void u()):(e.failure(s),void u())},f.onabort=function(){e.failure(s)},f.onerror=function(){e.failure(s)},void f.readAsDataURL(this.response)}if(4==t.tests.loading){var p=t.base64ArrayBuffer(this.response);a="data:"+o+";base64,"+p}}if(!a)return e.failure(s),void u();t.assetManager.cache[n]=a,e.success(a,s),u()}},c.onabort=function(){e.failure(s),u()},c.onerror=function(){e.failure(s),u()},c.send()}else if([1,2,3].contains(t.tests.loading)){var c=new XMLHttpRequest;c.open("GET",n,!0),c.overrideMimeType("text/plain; charset=x-user-defined"),c.onload=function(){if(200!=this.status&&0!=this.status||!this.responseText)e.failure(s),u();else{var i=!1;if([2,3].contains(t.tests.loading)){for(var a=this.responseText,r=a.length,h=new Uint8Array(r),l=0;l<r;l+=1)h[l]=255&a.charCodeAt(l);var c=window[t.prefixed("URL",window,!1)],d=!1;if(3==t.tests.loading)d=new Blob([h],{type:o});else if(2==t.tests.loading){var f=new(window[t.prefixed("BlobBuilder",window,!1)]);f.append(h.buffer),d=f.getBlob(o)}if(!d)return e.failure(s),void u();i=t.tests.blobrevoke?c.createObjectURL(d,{autoRevoke:!1}):c.createObjectURL(d),t.assetManager.blobs[n]=d}else if(1==t.tests.loading){for(var a=this.responseText,r=a.length,h=new Array(r),l=0;l<r;l+=1)h[l]=255&a.charCodeAt(l);a="";for(var p=65e3,l=0;l<r;l+=p)a+=String.fromCharCode.apply(null,h.slice(l,Math.min(l+p,r)));var g=window.btoa(a);i="data:"+o+";base64,"+g}if(!i)return e.failure(s),void u();t.assetManager.cache[n]=i,e.success(i,s),u()}},c.onabort=function(){e.failure(s),u()},c.onerror=function(){e.failure(s),u()},c.send()}else if(12==t.tests.loading){var c=new XMLHttpRequest;c.open("GET",n,!0),c.onload=function(){if(200!=this.status&&0!=this.status||!this.responseText)e.failure(s),u();else{for(var i=new VBArray(this.responseBody).toArray(),a=i.length,r="",h=65e3,l=0;l<a;l+=h)r+=String.fromCharCode.apply(null,i.slice(l,Math.min(l+h,a)));var c=window.btoa(r),d="data:"+o+";base64,"+c;t.assetManager.cache[n]=d,e.success(d,s),u()}},c.onabort=function(){e.failure(s),u()},c.onerror=function(){e.failure(s),u()},c.send()}else 0==t.tests.loading?(t.assetManager.cache[n]=n,e.success(n,s,!0),u()):(console.error("Invalid Sburb.tests.loading. Value = "+t.tests.loading),e.failure(s),u())},t.createGraphicAsset=function(e,i){var s=new Image;return s.type="graphic",s.name=e,s.originalVals=i,s.success=function(e){var n=i.substring(i.indexOf(".")+1,i.length),a=t.assetManager.mimes[n];s.src=e,"image/gif"==a&&t.Bins.gif.appendChild(s)},s.failure=function(){s.failed=!0},s.onload=function(){s.loaded=!0},s.onerror=s.failure,s.assetOnLoadFunction=function(t){return s.loaded?(t&&t(),!0):(s.onload=function(){s.loaded=!0,t&&t()},!1)},s.assetOnFailFunction=function(t){return s.failed?(t&&t(),!0):(s.failure=function(){!s.failed&&t&&t(),s.failed=!0},!1)},s.reload=function(){s.loaded=!1,s.failed=!1,t.loadGenericAsset(s,i)},s.reload(),s},t.createAudioAsset=function(e,i){if(!Modernizr.audio)return{name:e,type:"audio",originalVals:i,loaded:!0,instant:!0,paused:!0,ended:!0,currentTime:0,duration:0,load:function(){},play:function(){},loop:function(){},pause:function(){},addEventListener:function(){}};var s=new Audio;return s.name=e,s.type="audio",s.preload=!0,s.originalVals=i,s.failure=function(){s.failed=!0},s.isLoaded=function(){s.loaded=!0},s.checkLoaded=function(){s.loaded?delete t.assetManager.recurrences[e]:(s.check_count-=1,4==s.readyState?(delete t.assetManager.recurrences[e],s.isLoaded()):s.check_count?t.assetManager.recurrences[e]=setTimeout(s.checkLoaded,s.check_interval):(delete t.assetManager.recurrences[e],s.failure()))},s.assetOnLoadFunction=function(t){return s.loaded?(t&&t(),!0):(s.isLoaded=function(){s.loaded=!0,t&&t()},!1)},s.assetOnFailFunction=function(t){return s.failed?(t&&t(),!0):(s.failure=function(){!s.failed&&t&&t(),s.failed=!0},!1)},s.success=function(i,n,a){var o=document.createElement("source");o.src=i,s.appendChild(o),s.remaining-=1,s.remaining||(window.chrome&&s.load(),s.addEventListener("loadeddata",s.isLoaded,!1),a||(t.assetManager.recurrences[e]=setTimeout(s.checkLoaded,s.check_interval)))},s.reload=function(){s.remaining=0,s.check_interval=800,s.check_count=5,s.loaded=!1,s.failed=!1;for(var e=0;e<i.length;e++){var n=i[e].substring(i[e].indexOf(".")+1,i[e].length),a=t.assetManager.mimes[n];"audio/mpeg"==a?Modernizr.audio.mp3&&(s.remaining++,t.loadGenericAsset(s,i[e])):"audio/ogg"==a?Modernizr.audio.ogg&&(s.remaining++,t.loadGenericAsset(s,i[e])):(s.remaining++,t.loadGenericAsset(s,i[e]))}},s.reload(),s},t.createMovieAsset=function(e,i){var s={};return s.name=e,s.type="movie",s.originalVals=i,s.done=function(i){s.src=i,t.Bins.movie.innerHTML+='<div id="'+e+'"><object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" codebase="http://fpdownload.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=9,0,0,0" id="movie" width="'+t.Stage.width+'" height="'+t.Stage.height+'"><param name="allowScriptAccess" value="always" /><param name="wmode" value="transparent"/><param name="movie" value="'+s.src+'" /><param name="quality" value="high" /><embed src="'+s.src+'" quality="high" WMODE="transparent" width="'+t.Stage.width+'" height="'+t.Stage.height+'" swLiveConnect="true" id="movie'+e+'" name="movie'+e+'" allowScriptAccess="always" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer" /></object></div>',document.getElementById(e).style.display="none"},s.success=function(t){s.done(t),s.loaded=!0},s.failure=function(){s.failed=!0},s.assetOnLoadFunction=function(t){return s.loaded?(t&&t(),!0):(s.success=function(e){s.done(e),s.loaded=!0,t&&t()},!1)},s.assetOnFailFunction=function(t){return s.failed?(t&&t(),!0):(s.failure=function(){!s.failed&&t&&t(),s.failed=!0},!1)},s.reload=function(){s.loaded=!1,s.failed=!1,t.loadGenericAsset(s,i)},s.reload(),s},t.createPathAsset=function(t,e){var i=e;return i.name=t,i.type="path",i.instant=!0,i.assetOnLoadFunction=function(t){t&&t()},i.assetOnFailFunction=function(t){return!1},i},t.createFontAsset=function(e,i){var s={font:i[0]};return s.name=e,s.originalVals=i,s.type="font",s.done=function(t){s.loaded=!0},s.failure=function(){s.failed=!0},s.success=function(i,n){var a="url('"+i+"') format('"+s.sources[n]+"')";s.sources[n]=a,s.remaining-=1,s.remaining||(t.Bins.font.innerHTML+='<style type="text/css">@font-face{ font-family: '+s.name+"; src: "+s.sources.join(",")+"; "+s.extra+"}</style>",t.stage.font="10px "+e,s.done())},s.assetOnLoadFunction=function(t){return s.loaded?(t&&t(),!0):(s.done=function(e){s.loaded=!0,t&&t()},!1)},s.assetOnFailFunction=function(t){return s.failed?(t&&t(),!0):(s.failure=function(){!s.failed&&t&&t(),s.failed=!0},!1)},s.reload=function(){s.loaded=!1,s.failed=!1;var e=i.split(",");s.remaining=0,s.sources=[],s.extra="";for(var n=0;n<e.length;n++){var a=e[n].split(":"),o=a[0].trim(),r=a[1].trim();if("url"==o){var h=r.substring(r.indexOf(".")+1,r.length),l="";"ttf"==h?l="truetype":"woff"==h?l="woff":"svg"==h&&(l="svg"),s.remaining+=1,t.loadGenericAsset(s,r,s.sources.length),s.sources.push(l)}else"local"==o?s.sources.push("local('"+r+"')"):"weight"==o&&(s.extra+="font-weight:"+r+"; ")}},s.reload(),s},t.createTextAsset=function(t,e){var i={text:unescape(e).trim()};return i.name=t,i.type="text",i.instant=!0,i.assetOnLoadFunction=function(t){t&&t()},i.assetOnFailFunction=function(t){return!1},i},t}(Sburb||{}),Sburb=function(t){return t.Debugger=function(){this.url="http://sburb.info/report/version1/",this.fps=0,this.errors=[],this.xhrs=[],this.tests={},this.open=!1,this.tilde=!1,this.space=!1,this.getImg=!1,this.img=!1,this.report=!1,this.colors={error:"#CC0000",exception:"#990000",warn:"#CCCC00",info:"#000099",log:"#AAAAAA",debug:"#777777",success:"#00CC00",failure:"#CC0000",variant11:"#00CC00",variant10:"#00CC00",variant9:"#00CC00",variant8:"#00CC00",variant7:"#CCAA00",variant6:"#CCAA00",variant5:"#CCAA00",variant4:"#CCAA00",variant3:"#FF6600",variant2:"#FF6600",variant1:"#FF6600",variant12:"#FF6600",variant0:"#CC0000"},this.tests["Audio Support"]=t.tests.audio?"success":"failure",this.tests["Save Support"]=t.tests.storage?"success":"failure",this.tests["File Loading ["+t.tests.loading+"]"]="variant"+t.tests.loading;var e=this;this.console=new t.Console,this.XMLHttpRequest=window.XMLHttpRequest,window.XMLHttpRequest=function(){return new t.XMLHttpRequest},window.addEventListener("error",function(t){e.errors.push({type:t.type,text:t.message,url:t.filename,line:t.lineno,time:t.timeStamp})},!1)},t.Debugger.prototype.handleInputs=function(e){e[t.Keys.tilde]&&!this.tilde&&(this.tilde=!0,this.open=!this.open),e[t.Keys.space]&&!this.space&&this.open&&(this.space=!0,this.sendDebugReport()),e[t.Keys.tilde]||(this.tilde=!1),e[t.Keys.space]||(this.space=!1),e[t.Keys.escape]&&(this.open=!1)},t.Debugger.prototype.draw=function(){this.fps++;var e=this;if(setTimeout(function(){e.fps--},1e3),this.getImg&&(this.getImg=!1,this.img=t.Stage.toDataURL(),this.gotImg()),this.open){var i=t.stage.lineWidth,s=t.stage.strokeStyle;t.stage.lineWidth=9,t.stage.strokeStyle="#000000",t.stage.beginPath();for(var n=0;n<=t.Stage.height;n+=10)t.stage.moveTo(0,n),t.stage.lineTo(t.Stage.width,n);t.stage.closePath(),t.stage.stroke(),t.stage.lineWidth=i,t.stage.strokeStyle=s,t.stage.textAlign="left",t.stage.font="bold 18px Verdana";for(var a=this.errors.length-1,o=t.Stage.height-15;a>=0;a--,o-=24)this.errors[a].type in this.colors?t.stage.fillStyle=this.colors[this.errors[a].type]:t.stage.fillStyle="#000000",t.stage.fillText(this.errors[a].text,10,o);var o=70;t.stage.textAlign="right",t.stage.font="bold 18px Verdana";for(var r in this.tests)if(this.tests.hasOwnProperty(r)){var h=this.tests[r],l=t.stage.measureText(r).width;t.stage.fillStyle=this.colors[h],t.stage.fillRect(t.Stage.width-(l+20),o,l+10,24),t.stage.fillStyle="#FFFFFF",t.stage.fillText(r,t.Stage.width-15,o+18),o+=26}t.stage.fillStyle="#000000",t.stage.fillRect(t.Stage.width/2-125,10,250,65),t.stage.textAlign="center",t.stage.fillStyle="#FFFFFF",t.stage.font="bold 28px Verdana",t.stage.fillText("Sburb Debugger",t.Stage.width/2,33),t.stage.font="14px Verdana",t.stage.fillText("Press SPACE to send bug report",t.Stage.width/2,51),t.stage.fillText("Press ~ or ESC to exit",t.Stage.width/2,67),t.stage.fillStyle="#000000",t.stage.fillRect(t.Stage.width-50,t.Stage.height-25,50,25),t.stage.textAlign="right",t.stage.fillStyle="#FFFFFF",t.stage.font="bold 16px Verdana",t.stage.fillText(this.fps+"fps",t.Stage.width-8,t.Stage.height-10),t.stage.textAlign="center",t.stage.fillStyle="#000000"}},t.Debugger.prototype.sendDebugReport=function(){var e=document.createElement("div"),i=document.createElement("h2"),s=document.createElement("form"),n=document.createElement("textarea"),a=document.createElement("input");e.id="sburb_debug_report",e.style.position="absolute",e.style.zIndex="9999",e.style.background="white",e.style.width="550px",e.style.top="100px",e.style.left="50px",i.innerText="What seems to be the problem?",i.style.margin="0 20px",s.method="POST",s.action="#",s.style.textAlign="right",s.onsubmit=this.submitForm,n.id="sburb_debug_report_box",n.style.width="530px",n.style.height="200px",n.style.margin="0 8px",n.style.display="block",a.type="submit",a.value="Send Bug Report",s.appendChild(n),s.appendChild(a),e.appendChild(i),e.appendChild(s),t.Game.parentNode.appendChild(e),n.focus()},t.Debugger.prototype.submitForm=function(){var e=document.getElementById("sburb_debug_report");return t.debugger.report=document.getElementById("sburb_debug_report_box").value,t.debugger.getImg=!0,e.parentNode.removeChild(e),!1},t.Debugger.prototype.gotImg=function(){var e={fps:this.fps,errors:this.errors,tests:this.tests,xhrs:this.xhrs},i={debugger:JSON.stringify(e),canvas:this.img.substr(22),report:this.report,url:location.href,save:t.serialize(t)},s=[],n="";for(k in i)i.hasOwnProperty(k)&&s.push(encodeURIComponent(k)+"="+encodeURIComponent(i[k]));n=s.join("&");var a=new XMLHttpRequest;a.open("POST",this.url,!0),a.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),a.onload=function(){if(200!=this.status&&0!=this.status||!this.responseText)console.debug("Bug report failed to send.");else{var t=JSON.parse(this.responseText);"success"in t&&t.success?console.debug("Bug report sent."):console.debug("Bug report failed to save.")}},a.onerror=function(){console.debug("Bug report failed to send.")},a.onabort=function(){console.debug("Bug report failed to send.")},a.send(n)},t.Console=function(){var e=this._console=window.console;window.console=this;var i={log:1,debug:1,info:1,warn:1,error:1,exception:1},s=function(t){return t&&"[object Function]"==={}.toString.call(t)},n=function(e,i){var s=Array.prototype.slice.call(i);t.debugger.errors.push({type:e,text:s.join(", ")})},a=function(t,i){return e[t].apply(e,i)};for(var o in e)if(!(o in i))try{s(e[o])?"undefined"==typeof this[o]&&(this[o]=function(t,e){return function(){return e(t,arguments)}}(o,a)):this[o]=e[o]}catch(t){}return this.log=function(){return n("log",arguments),a("log",arguments)},this.debug=function(){return n("debug",arguments),a("debug",arguments)},this.info=function(){return n("info",arguments),a("info",arguments)},this.warn=function(){return n("warn",arguments),a("warn",arguments)},this.error=function(){return n("error",arguments),a("error",arguments)},this.exception=function(){return n("exception",arguments),a("exception",arguments)},this},t.XMLHttpRequest=function(){var e=this,i=e._xhr=new t.debugger.XMLHttpRequest;e.reqType=null,e.reqUrl=null,e.reqStart=null,e.readyState=0,e.onreadystatechange=function(){},e.spy={requestHeaders:[],responseHeaders:[],method:null,url:null,async:null,loaded:!1,status:null,statusText:null,data:null};var s=(e.xhr&&e.xhr.open&&"undefined"!=e.xhr.open.apply,function(t){return t&&"[object Function]"==={}.toString.call(t)}),n={abort:1,channel:1,getInterface:1,mozBackgroundRequest:1,multipart:1,onreadystatechange:1,open:1,send:1,setRequestHeader:1},a={channel:1,onreadystatechange:1,readyState:1,responseBody:1,responseText:1,responseXML:1,status:1,statusText:1,upload:1,spy:1,_xhr:1},o=function(){for(var t in i)if(!(t in n))try{i[t]&&!s(i[t])&&(e[t]=i[t])}catch(t){}},r=function(){for(var t in e)if(!(t in a))try{e[t]&&!i[t]&&(i[t]=e[t])}catch(t){}},h=function(){for(var s=((new Date).getTime()-e.reqStart,200==i.status||0==i.status),n=i.status+" "+i.statusText,a=i.getAllResponseHeaders(),r=a?a.split(/[\n\r]/):[],h=/^(\S+):\s*(.*)/,l=0,u=r.length;l<u;l++){var c=r[l],d=c.match(h);if(d){var f=d[1],p=d[2];"Content-Type"==f&&(e.spy.mimeType=p),e.spy.responseHeaders.push({name:f,value:p})}}e.spy.loaded=!0,e.spy.status=i.status,e.spy.statusText=n,o(),t.debugger.xhrs.push(e.spy),s||console.warn("XHR for "+e.spy.url+" failed")},l=function(){e.readyState=i.readyState,4==i.readyState&&(h(),i.onreadystatechange=function(){}),e.onreadystatechange()};this.open=function(t,s,n,a,r){o(),e.spy.method=t,e.spy.url=s,
e.spy.async=n,n&&(i.onreadystatechange=l),this.supportsApply?i.open.apply(i,arguments):i.open(t,s,n,a,r)},this.send=function(t){e.spy.data=t,e.reqStart=(new Date).getTime(),r();try{i.send(t)}catch(t){throw t}finally{e.spy.async||(e.readyState=i.readyState,h())}},this.setRequestHeader=function(t,s){return e.spy.requestHeaders.push({name:t,value:s}),i.setRequestHeader(t,s)},this.abort=function(){i.abort(),o(),handleRequestStatus(!1,"Aborted")};for(var u in i)if(!(u in n))try{s(i[u])?"undefined"==typeof e[u]&&(e[u]=function(t,e){return this.supportsApply?function(){return e[t].apply(e,arguments)}:function(i,s,n,a,o){return e[t](i,s,n,a,o)}}(u,i)):e[u]=i[u]}catch(t){}return this},t}(Sburb||{}),Sburb=function(t){return t.Path=function(){this.points=[]},t.Path.prototype.push=function(t){this.points.push(t)},t.Path.prototype.queryBatchPos=function(t,e){for(var i in t)t.hasOwnProperty(i)&&(e[i]=e[i]||this.query(t[i]))},t.Path.prototype.queryBatchNeg=function(t,e){for(var i in t)t.hasOwnProperty(i)&&(e[i]=e[i]&&!this.query(t[i]))},t.Path.prototype.query=function(t){for(var e=!1,i=-1,s=this.points.length,n=s-1;++i<s;n=i){var a=this.points[i],o=this.points[n];(a.y<=t.y&&t.y<o.y||o.y<=t.y&&t.y<a.y)&&t.x<(o.x-a.x)*(t.y-a.y)/(o.y-a.y)+a.x&&(e=!e)}return e},t}(Sburb||{}),Sburb=function(t){return t.ActionQueue=function(e,i,s,n,a,o){this.curAction=e,this.id=i&&i.length>0?i:t.nextQueueId++,this.groups=s?s:[],this.noWait=!!n&&n,this.paused=!!a,this.trigger=o},t.ActionQueue.prototype.hasGroup=function(t){for(var e=0;e<this.groups.length;e++)if(this.groups[e]==t)return!0;return!1},t.ActionQueue.prototype.serialize=function(e){if(!this.curAction)return"";for(var i="",s=0;s<this.groups.length;s++)i+=(s>0?":":"")+this.groups[s];return e=e.concat("\n<actionQueue "+t.serializeAttributes(this,"id","noWait","paused")+(0==i.length?"":" groups='"+i+"'")+">"),e=this.curAction.serialize(e),this.trigger&&(e=this.trigger.serialize(e)),e=e.concat("</actionQueue>")},t.getActionQueueById=function(t){for(var e=0;e<this.actionQueues.length;e++){var i=this.actionQueues[e];if(i.id==t)return i}},t.removeActionQueueById=function(t){for(var e=0;e<this.actionQueues.length;e++){var i=this.actionQueues[e];if(i.id==t)return void this.actionQueues.remove(e)}},t.forEachActionQueueInGroup=function(t,e){for(var i=0;i<this.actionQueues.length;i++){var s=this.actionQueues[i];s.hasGroup(t)&&e(s)}},t.removeActionQueuesByGroup=function(t){for(var e=0;e<this.actionQueues.length;e++){var i=this.actionQueues[e];i.hasGroup(t)&&(this.actionQueues.remove(e),e--)}},t.parseActionQueue=function(e){for(var i=e.attributes,s=null,n=0,a=null,o=!1,r=!1,h=null,l=e.childNodes,u=0;u<l.length;u++)"#text"!=l[u].nodeName&&("action"==l[u].nodeName?s=t.parseAction(l[u]):h=t.parseTrigger(l[u]));var c;return n=(c=i.getNamedItem("id"))?c.value:t.nextQueueId++,a=(c=i.getNamedItem("groups"))?c.value.split(":"):a,o=(c=i.getNamedItem("noWait"))?"true"==c.value:o,r=(c=i.getNamedItem("paused"))?"true"==c.value:r,new t.ActionQueue(s,n,a,o,r,h)},t}(Sburb||{});
